<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>K8s-kubernetes基于二进制搭建 | zaza的博客</title>
    <meta property="og:title" content="K8s-kubernetes基于二进制搭建 - zaza的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-06-02T10:25:11&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-06-02T10:25:11&#43;08:00'>
        
    <meta name="Keywords" content="程序员,软件开发,code,coding,shell,bash,python,go,java,axios,css,database,debug,mysql,javascript,linux,os,programmer,programming,sql,ubuntu,centos,web">
    <meta name="description" content="K8s-kubernetes基于二进制搭建">
        
    <meta name="author" content="zaza">
    <meta property="og:url" content="https://zazayaya.github.io/2021/06/02/k8s-install-by-binary.html">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zazayaya.github.io/">
                        zaza的博客
                    </a>
                
                <p class="description">系统运维</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://zazayaya.github.io/">首页</a>
                    
                    <a  href="https://zazayaya.github.io/archives.html" title="归档">归档</a>
                    
                    <a  href="https://zazayaya.github.io/about.html" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
         
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#选型">选型</a>
      <ul>
        <li><a href="#二进制安装">二进制安装？</a></li>
        <li><a href="#使用cfssl做为证书工具">使用cfssl做为证书工具</a></li>
        <li><a href="#为何不使用supervisord管理进程而使用systemd">为何不使用supervisord管理进程，而使用systemd</a></li>
      </ul>
    </li>
    <li><a href="#版本说明">版本说明</a></li>
    <li><a href="#服务器准备">服务器准备</a></li>
    <li><a href="#证书准备">证书准备</a>
      <ul>
        <li><a href="#安装软件">安装软件</a></li>
        <li><a href="#生成根证书">生成根证书</a></li>
        <li><a href="#生成各个服务证书">生成各个服务证书</a></li>
        <li><a href="#证书列表">证书列表</a></li>
      </ul>
    </li>
    <li><a href="#master各个组件安装">master各个组件安装</a>
      <ul>
        <li><a href="#环境准备">环境准备</a></li>
        <li><a href="#etcd">etcd</a>
          <ul>
            <li><a href="#安装">安装</a></li>
            <li><a href="#systemd服务单元配置">systemd服务单元配置</a></li>
            <li><a href="#配置启动依赖">配置启动依赖</a></li>
            <li><a href="#启动">启动</a></li>
            <li><a href="#状态检测">状态检测</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes-server">kubernetes-server</a>
          <ul>
            <li><a href="#下载安装">下载安装</a></li>
            <li><a href="#kube-apiserver配置">kube-apiserver配置</a></li>
            <li><a href="#kube-controller-manager配置">kube-controller-manager配置</a></li>
            <li><a href="#kube-scheduler配置">kube-scheduler配置</a></li>
            <li><a href="#kubectl配置">kubectl配置</a></li>
            <li><a href="#dashboard">dashboard</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#node各个组件安装">node各个组件安装</a>
      <ul>
        <li><a href="#环境准备-1">环境准备</a>
          <ul>
            <li><a href="#证书准备-1">证书准备</a></li>
          </ul>
        </li>
        <li><a href="#安装flannel">安装flannel</a>
          <ul>
            <li><a href="#下载安裝">下载安裝</a></li>
            <li><a href="#运行原理">运行原理</a></li>
            <li><a href="#systemd服务单元配置-4">systemd服务单元配置</a></li>
            <li><a href="#配置说明">配置说明</a></li>
            <li><a href="#配置启动依赖-4">配置启动依赖</a></li>
            <li><a href="#启动-4">启动</a></li>
          </ul>
        </li>
        <li><a href="#安装docker">安装docker</a>
          <ul>
            <li><a href="#下载安装-1">下载安装</a></li>
            <li><a href="#systemd服务单元配置-5">systemd服务单元配置</a></li>
            <li><a href="#配置启动依赖-5">配置启动依赖</a></li>
            <li><a href="#启动-5">启动</a></li>
            <li><a href="#状态检测-1">状态检测</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes-node">kubernetes-node</a>
          <ul>
            <li><a href="#下载安装-2">下载安装</a></li>
            <li><a href="#kubelet配置">kubelet配置</a></li>
            <li><a href="#kube-proxy配置">kube-proxy配置</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#验证">验证</a>
      <ul>
        <li><a href="#查看节点是否加入">查看节点是否加入</a></li>
        <li><a href="#创建pod和service进行测试master">创建pod和service进行测试(master)</a></li>
      </ul>
    </li>
    <li><a href="#新节点加入">新节点加入</a>
      <ul>
        <li><a href="#kubelet证书刷新">kubelet证书刷新</a></li>
        <li><a href="#同步pki目录文件">同步pki目录文件</a></li>
        <li><a href="#环境准备-2">环境准备</a></li>
        <li><a href="#安装flannel-1">安装flannel</a>
          <ul>
            <li><a href="#下载安裝-1">下载安裝</a></li>
            <li><a href="#systemd服务单元配置-8">systemd服务单元配置</a></li>
            <li><a href="#配置说明-1">配置说明</a></li>
            <li><a href="#配置启动依赖-8">配置启动依赖</a></li>
            <li><a href="#启动-8">启动</a></li>
          </ul>
        </li>
        <li><a href="#安装docker-1">安装docker</a>
          <ul>
            <li><a href="#下载安装-3">下载安装</a></li>
            <li><a href="#配置">配置</a></li>
            <li><a href="#systemd服务单元配置-9">systemd服务单元配置</a></li>
            <li><a href="#启动-9">启动</a></li>
            <li><a href="#状态检测-2">状态检测</a></li>
          </ul>
        </li>
        <li><a href="#kubernetes-node-1">kubernetes-node</a>
          <ul>
            <li><a href="#下载安装-4">下载安装</a></li>
            <li><a href="#kubelet配置-1">kubelet配置</a></li>
            <li><a href="#kube-proxy配置-1">kube-proxy配置</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#常见问题">常见问题</a>
      <ul>
        <li><a href="#kubelet启动异常">kubelet启动异常</a></li>
        <li><a href="#kube-proxy警告">kube-proxy警告</a></li>
      </ul>
    </li>
    <li><a href="#核心插件">核心插件</a>
      <ul>
        <li><a href="#cni网络插件flannel">CNI网络插件Flannel</a></li>
        <li><a href="#coredns服务发现">CoreDNS服务发现</a>
          <ul>
            <li><a href="#环境准备-3">环境准备</a></li>
            <li><a href="#拉取镜像">拉取镜像</a></li>
            <li><a href="#coredns配置清单">coredns配置清单</a></li>
            <li><a href="#应用coredns配置">应用coredns配置</a></li>
            <li><a href="#测试">测试</a></li>
          </ul>
        </li>
        <li><a href="#ingress服务暴露控制器-traefik">ingress(服务暴露)控制器-traefik</a></li>
        <li><a href="#dashboardkubernetes-集群的通用web-ui">dashboard（Kubernetes 集群的通用Web UI）</a></li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">K8s-kubernetes基于二进制搭建</h1>
        </header>
        <date class="post-meta meta-date">
            2021年6月2日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/Kubernetes'>Kubernetes</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="选型">选型</h2>
<h3 id="二进制安装">二进制安装？</h3>
<p>方便了解各个模块运行机制，同时支持各种版本的系统</p>
<h3 id="使用cfssl做为证书工具">使用cfssl做为证书工具</h3>
<p>生成标准的命名方式，方便统一，json做为配置文件，方便阅读</p>
<h3 id="为何不使用supervisord管理进程而使用systemd">为何不使用supervisord管理进程，而使用systemd</h3>
<p>目前主流的系统都是systemd作为进程管理，具有通用性。</p>
<p>supervisord基于python开发进程管理组件，需要单独安装</p>
<h2 id="版本说明">版本说明</h2>
<blockquote>
<p>kubernetes 1.23 + 不支持docker
kubernetes Open Container Initiative（OCI）支持 lxc、runc 和 rkt 目前主流的三种容器 runtime
lxc 是 Linux 上老牌的容器 runtime。Docker 最初也是用 lxc 作为 runtime。
runc 是 Docker 自己开发的容器 runtime，符合 oci 规范，也是现在 Docker 的默认 runtime。
rkt 是 CoreOS 开发的容器 runtime，符合 oci 规范，因而能够运行 Docker 的容器。</p>
</blockquote>
<h2 id="服务器准备">服务器准备</h2>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>IP</strong></th>
<th style="text-align:center"><!-- raw HTML omitted -->  节点  <!-- raw HTML omitted --></th>
<th style="text-align:center"><!-- raw HTML omitted -->  配置  <!-- raw HTML omitted --></th>
<th style="text-align:center"><strong>组件</strong></th>
<th><!-- raw HTML omitted --> 说明 <!-- raw HTML omitted --></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10.0.26.180</td>
<td style="text-align:center">k8s-master-01</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">kube-apiserver，kube-controller-manager，kube-scheduler，kubectl，etcd</td>
<td>主控节点</td>
</tr>
<tr>
<td style="text-align:center">10.0.26.190</td>
<td style="text-align:center">k8s-node-01</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">flannel，docker，kubelet，kube-proxy</td>
<td>运算节点</td>
</tr>
<tr>
<td style="text-align:center">10.0.26.191</td>
<td style="text-align:center">k8s-node-02</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">flannel，docker，kubelet，kube-proxy</td>
<td>运算节点</td>
</tr>
</tbody>
</table>
<ul>
<li>客户端包：kubernetes-client-linux-amd64.tar.gz  （kubectl和kubectl-convert）</li>
<li>node端包：kubernetes-node-linux-amd64.tar.gz   （包含客户端包+kubeadm+kubelet+kube-proxy）</li>
<li>服务端包：kubernetes-server-linux-amd64.tar.gz  （包含客户端包+node端包+kube-apiserver+kube-controller-manager+kube-scheduler+mounter+镜像文件）</li>
</ul>
<h2 id="证书准备">证书准备</h2>
<blockquote>
<p>将证书软件安装到相关服务器上面：比如独立的证书服务器，本文放在master上面用于测试</p>
</blockquote>
<h3 id="安装软件">安装软件</h3>
<blockquote>
<p>其实就是三个二进制文件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget -O /usr/bin/cfssl https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl_1.5.0_linux_amd64
</span></span><span style="display:flex;"><span>wget -O /usr/bin/cfssljson https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssljson_1.5.0_linux_amd64
</span></span><span style="display:flex;"><span>wget -O /usr/bin/cfssl-certinfo https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl-certinfo_1.5.0_linux_amd64
</span></span><span style="display:flex;"><span>chmod +x /usr/bin/cfssl*
</span></span></code></pre></div><h3 id="生成根证书">生成根证书</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成默认配置</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cfssl print-defaults config &gt; ca-config.json</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cfssl print-defaults csr &gt; ca-csr.json</span>
</span></span><span style="display:flex;"><span>mkdir -pv /etc/kubernetes/pki
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建生成CA证书的JSON配置文件</span>
</span></span><span style="display:flex;"><span>cat &gt; ca-config.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14"> &#34;signing&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">     &#34;default&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         &#34;expiry&#34;: &#34;175200h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">     },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">     &#34;profiles&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         &#34;server&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             &#34;expiry&#34;: &#34;175200h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;server auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         &#34;client&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             &#34;expiry&#34;: &#34;175200h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         &#34;peer&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             &#34;expiry&#34;: &#34;175200h&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             &#34;usages&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;signing&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;key encipherment&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;server auth&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">                 &#34;client auth&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">             ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">         }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">     }
</span></span></span><span style="display:flex;"><span><span style="color:#d14"> }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建生成CA证书签名请求（csr）的JSON配置文件</span>
</span></span><span style="display:flex;"><span>cat &gt; ca-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;Zaza Root CA&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;IT&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;ca&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;expiry&#34;: &#34;175200h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成私钥、根证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</span></span></code></pre></div><h3 id="生成各个服务证书">生成各个服务证书</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># etcd证书请求文件</span>
</span></span><span style="display:flex;"><span>cat &gt; etcd-peer-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;etcd-peer&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.180&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;IT&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>peer etcd-peer-csr.json | cfssljson -bare etcd-peer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># client证书请求文件</span>
</span></span><span style="display:flex;"><span>cat &gt; client-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;k8s-node&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;CN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>client client-csr.json | cfssljson -bare client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># apiserver证书请求文件</span>
</span></span><span style="display:flex;"><span>cat &gt; apiserver-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;k8s-apiserver&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.26.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.180&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;system&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>server apiserver-csr.json | cfssljson -bare apiserver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kube-controller-manager证书请求文件</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注：hosts 列表包含所有 kube-controller-manager 节点 IP；CN 为 system:kube-controller-manager、O 为 system:kube-controller-manager，kubernetes 内置的 ClusterRoleBindings system:kube-controller-manager 赋予 kube-controller-manager 工作所需的权限。</span>
</span></span><span style="display:flex;"><span>cat &gt; kube-controller-manager-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.26.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.180&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;system:kube-controller-manager&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;system&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>peer kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kube-scheduler证书请求文件</span>
</span></span><span style="display:flex;"><span>cat &gt; kube-scheduler-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;system:kube-scheduler&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.26.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.180&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc.cluster&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;kubernetes.default.svc.cluster.local&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;system:kube-scheduler&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;system&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>peer kube-scheduler-csr.json | cfssljson -bare kube-scheduler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl证书请求文件(需要拷贝到每个node节点)</span>
</span></span><span style="display:flex;"><span>cat &gt; admin-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;system&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>peer admin-csr.json | cfssljson -bare admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubelet证书请求文件</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意主机列表，有新增ip则重新生成即可</span>
</span></span><span style="display:flex;"><span>cat &gt; kubelet-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;k8s-kubelet&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.180&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.190&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.191&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;IT&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书(需要拷贝到每个node节点)</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>server kubelet-csr.json | cfssljson -bare kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kube-proxy证书请求文件</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注：这里CN对应的是k8s中的角色名</span>
</span></span><span style="display:flex;"><span>cat &gt; kube-proxy-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;IT&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书(需要拷贝到每个node节点)</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>client kube-proxy-csr.json | cfssljson -bare kube-proxy-client
</span></span></code></pre></div><h3 id="证书列表">证书列表</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 18个证书</span>
</span></span><span style="display:flex;"><span>root@k8s-master-01:/etc/kubernetes/pki# ll *pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">24</span> 09:22 admin-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">24</span> 09:22 admin.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">24</span> 08:16 apiserver-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1614</span> May <span style="color:#099">24</span> 08:16 apiserver.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">24</span> 08:10 ca-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1342</span> May <span style="color:#099">24</span> 08:10 ca.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">24</span> 08:16 client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1407</span> May <span style="color:#099">24</span> 08:16 client.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> etcd etcd <span style="color:#099">1675</span> May <span style="color:#099">24</span> 08:13 etcd-peer-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1480</span> May <span style="color:#099">24</span> 08:13 etcd-peer.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">24</span> 09:10 kube-controller-manager-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">24</span> 09:10 kube-controller-manager.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1675</span> May <span style="color:#099">24</span> 08:21 kubelet-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1436</span> May <span style="color:#099">24</span> 08:21 kubelet.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">24</span> 08:23 kube-proxy-client-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1419</span> May <span style="color:#099">24</span> 08:23 kube-proxy-client.pem
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">1679</span> May <span style="color:#099">24</span> 09:12 kube-scheduler-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">1651</span> May <span style="color:#099">24</span> 09:12 kube-scheduler.pem
</span></span></code></pre></div><h2 id="master各个组件安装">master各个组件安装</h2>
<blockquote>
<p>etcd、kube-apiserver、kube-controller-manager、kube-scheduler、kubectl</p>
</blockquote>
<h3 id="环境准备">环境准备</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostnamectl set-hostname k8s-master-01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -q k8s-master-01 /etc/hosts <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; /etc/hosts <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.180 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.190 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.191 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h3 id="etcd">etcd</h3>
<h4 id="安装">安装</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 下载</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src/
</span></span><span style="display:flex;"><span>wget https://github.com/etcd-io/etcd/releases/download/v3.4.16/etcd-v3.4.16-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 安装</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -d /usr/local/etcd <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>tar zxf etcd-v3.4.16-linux-amd64.tar.gz <span style="color:#000;font-weight:bold">&amp;&amp;</span> mv -v etcd-v3.4.16-linux-amd64 /usr/local/etcd<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建软连接</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -L /usr/bin/etcd <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> ln -sv /usr/local/etcd/etcd /usr/bin/etcd
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -L /usr/bin/etcdctl <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> ln -sv /usr/local/etcd/etcdctl /usr/bin/etcdctl
</span></span></code></pre></div><h4 id="systemd服务单元配置">systemd服务单元配置</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/etcd.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=etcd - highly-available key value store
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/coreos/etcd
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=man:etcd
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/usr/local/etcd/etc/etcd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">User=etcd
</span></span></span><span style="display:flex;"><span><span style="color:#d14">PermissionsStartOnly=true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/bin/etcd $ETCD_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-abnormal
</span></span></span><span style="display:flex;"><span><span style="color:#d14">#RestartSec=10s
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="配置启动依赖">配置启动依赖</h4>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
<p>enable-v2=true 主要用于flannel</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /usr/local/etcd/etc
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/etcd/etc <span style="color:#000;font-weight:bold">&amp;&amp;</span> touch etcd.conf
</span></span><span style="display:flex;"><span>grep -q ETCD_ARGS etcd.conf <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; etcd.conf <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ETCD_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --name=etcd-server-5-180
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --data-dir=/data/etcd/etcd-server
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --listen-client-urls=https://10.0.26.180:2379,http://127.0.0.1:2379
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --advertise-client-urls=https://10.0.26.180:2379,http://127.0.0.1:2379
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --listen-peer-urls=https://10.0.26.180:2380
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --initial-advertise-peer-urls=https://10.0.26.180:2380
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --initial-cluster=etcd-server-5-189=https://10.0.26.180:2380
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --quota-backend-bytes=8000000000
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --cert-file=/etc/kubernetes/pki/etcd-peer.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --key-file=/etc/kubernetes/pki/etcd-peer-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --peer-cert-file=/etc/kubernetes/pki/etcd-peer.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --peer-key-file=/etc/kubernetes/pki/etcd-peer-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --trusted-ca-file=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --peer-trusted-ca-file=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --log-outputs=stdout
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --logger=zap
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    --enable-v2=true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>创建用户、创建目录、授权</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>useradd -M -s /usr/sbin/nologin etcd
</span></span><span style="display:flex;"><span>mkdir -p /data/etcd /data/logs/etcd-server /data/etcd/etcd-server
</span></span><span style="display:flex;"><span>chown -R etcd: /data/etcd /data/logs/etcd-server /data/etcd/etcd-server
</span></span><span style="display:flex;"><span>chown etcd: /etc/kubernetes/pki/etcd-peer-key.pem
</span></span></code></pre></div><blockquote>
<p>配置alias方便使用</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>grep -q etcdctl ~/.bashrc <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; ~/.bashrc <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">export ENDPOINTS=https://10.0.26.180:2379
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># alias etcdctl=&#39;etcdctl --endpoints=${ENDPOINTS} --user=root:123456&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">alias etcdctl=&#39;ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/ca.pem --cert=/etc/kubernetes/pki/etcd-peer.pem --key=/etc/kubernetes/pki/etcd-peer-key.pem --endpoints=${ENDPOINTS}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 这里需要完整路径，否者etcdctl会被解析成alias的etcdctl
</span></span></span><span style="display:flex;"><span><span style="color:#d14">alias etcdctl2=&#39;ETCDCTL_API=2 /usr/bin/etcdctl --ca-file=/etc/kubernetes/pki/ca.pem --cert-file=/etc/kubernetes/pki/etcd-peer.pem --key-file=/etc/kubernetes/pki/etcd-peer-key.pem --endpoints=${ENDPOINTS}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">source</span> ~/.bashrc
</span></span></code></pre></div><h4 id="启动">启动</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> etcd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start etcd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status etcd.service
</span></span></code></pre></div><h4 id="状态检测">状态检测</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看集群状态信息</span>
</span></span><span style="display:flex;"><span>etcdctl --write-out<span style="color:#000;font-weight:bold">=</span>table endpoint status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看集群状态</span>
</span></span><span style="display:flex;"><span>etcdctl endpoint health
</span></span></code></pre></div><h3 id="kubernetes-server">kubernetes-server</h3>
<h4 id="下载安装">下载安装</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src/
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/v1.21.1/kubernetes-server-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -d /usr/local/kubernetes <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> tar xzvf kubernetes-server-linux-amd64.tar.gz -C /usr/local/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建软连接</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -L /usr/bin/kubectl <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> ln -sv /usr/local/kubernetes/server/bin/kubectl /usr/bin/kubectl
</span></span></code></pre></div><h4 id="kube-apiserver配置">kube-apiserver配置</h4>
<h5 id="systemd服务单元配置-1">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kube-apiserver.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes API Service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=etcd.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/kubernetes/server/bin/kube-apiserver $KUBE_API_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-1">配置启动依赖</h5>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>touch /etc/kubernetes/apiserver
</span></span><span style="display:flex;"><span>grep -q KUBE_API_ARGS /etc/kubernetes/apiserver <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; /etc/kubernetes/apiserver <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KUBE_API_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit.log
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --audit-policy-file /etc/kubernetes/audit.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --token-auth-file /etc/kubernetes/token.csv
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --authorization-mode RBAC
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --client-ca-file /etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --requestheader-client-ca-file /etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-cafile /etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-certfile /etc/kubernetes/pki/client.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-keyfile /etc/kubernetes/pki/client-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-servers https://10.0.26.180:2379
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-account-key-file /etc/kubernetes/pki/ca-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-account-signing-key-file /etc/kubernetes/pki/ca-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-account-issuer=https://kubernetes.default.svc.cluster.local
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-cluster-ip-range 10.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-node-port-range 3000-29999
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --target-ram-mb=1024
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubelet-client-certificate /etc/kubernetes/pki/client.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubelet-client-key /etc/kubernetes/pki/client-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --log-dir  /data/logs/kubernetes/kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-cert-file /etc/kubernetes/pki/apiserver.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-private-key-file /etc/kubernetes/pki/apiserver-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --v 2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>创建审计日志配置</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /etc/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/audit.yaml <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">apiVersion: audit.k8s.io/v1 # This is required.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">kind: Policy
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># Don&#39;t generate audit events for all requests in RequestReceived stage.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">omitStages:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - &#34;RequestReceived&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">rules:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Log pod changes at RequestResponse level
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: RequestResponse
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      # Resource &#34;pods&#34; doesn&#39;t match requests to any subresource of pods,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      # which is consistent with the RBAC policy.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resources: [&#34;pods&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Log &#34;pods/log&#34;, &#34;pods/status&#34; at Metadata level
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: Metadata
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resources: [&#34;pods/log&#34;, &#34;pods/status&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Don&#39;t log requests to a configmap called &#34;controller-leader&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: None
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resources: [&#34;configmaps&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resourceNames: [&#34;controller-leader&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Don&#39;t log watch requests by the &#34;system:kube-proxy&#34; on endpoints or services
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: None
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    users: [&#34;system:kube-proxy&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    verbs: [&#34;watch&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34; # core API group
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resources: [&#34;endpoints&#34;, &#34;services&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Don&#39;t log authenticated requests to certain non-resource URL paths.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: None
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    userGroups: [&#34;system:authenticated&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    nonResourceURLs:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - &#34;/api*&#34; # Wildcard matching.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - &#34;/version&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Log the request body of configmap changes in kube-system.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: Request
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34; # core API group
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resources: [&#34;configmaps&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # This rule only applies to resources in the &#34;kube-system&#34; namespace.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # The empty string &#34;&#34; can be used to select non-namespaced resources.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    namespaces: [&#34;kube-system&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Log configmap and secret changes in all other namespaces at the Metadata level.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: Metadata
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34; # core API group
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      resources: [&#34;secrets&#34;, &#34;configmaps&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # Log all other resources in core and extensions at the Request level.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: Request
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    resources:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;&#34; # core API group
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    - group: &#34;extensions&#34; # Version of group should NOT be included.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  # A catch-all rule to log all other requests at the Metadata level.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - level: Metadata
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # Long-running requests like watches that fall under this rule will not
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # generate an audit event in RequestReceived.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    omitStages:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      - &#34;RequestReceived&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>创建token文件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/kubernetes/token.csv <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;),kubelet-bootstrap,10001,&#34;system:kubelet-bootstrap&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>创建依赖目录</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /data/logs/kubernetes/kube-apiserver
</span></span></code></pre></div><h5 id="启动-1">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kube-apiserver.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kube-apiserver.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kube-apiserver.service
</span></span></code></pre></div><h4 id="kube-controller-manager配置">kube-controller-manager配置</h4>
<h5 id="生成kubeconfig证书用于tls认证">生成kubeconfig证书(用于TLS认证)</h5>
<blockquote>
<p>kubeconfig是一个配置文件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置集群参数：初始化cluster基础配置文件，包含连接kube-apiserver的地址和证书</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#000;font-weight:bold">=</span>ca.pem --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --server<span style="color:#000;font-weight:bold">=</span>https://10.0.26.180:6443 --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-controller-manager.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置客户端认证参数：设置users信息，包含客户端证书信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials system:kube-controller-manager --client-certificate<span style="color:#000;font-weight:bold">=</span>kube-controller-manager.pem --client-key<span style="color:#000;font-weight:bold">=</span>kube-controller-manager-key.pem --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-controller-manager.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置上下文参数：设置contexts信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-context system:kube-controller-manager --cluster<span style="color:#000;font-weight:bold">=</span>kubernetes --user<span style="color:#000;font-weight:bold">=</span>system:kube-controller-manager --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-controller-manager.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置默认上下文：设置current-context的值</span>
</span></span><span style="display:flex;"><span>kubectl config use-context system:kube-controller-manager --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-controller-manager.kubeconfig
</span></span></code></pre></div><h5 id="systemd服务单元配置-2">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kube-controller-manager.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes Controller Manager
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/kubernetes/server/bin/kube-controller-manager $DAEMON_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-2">配置启动依赖</h5>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/kubernetes/controller-manager <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">DAEMON_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-cidr=172.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --log-dir=/data/logs/kubernetes/kube-controller-manager
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubeconfig=/etc/kubernetes/pki/kube-controller-manager.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-name=kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --service-cluster-ip-range=10.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --root-ca-file=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem 
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-cert-file=/etc/kubernetes/pki/kube-controller-manager.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-private-key-file=/etc/kubernetes/pki/kube-controller-manager-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --controllers=*,bootstrapsigner,tokencleaner
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --use-service-account-credentials=true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --alsologtostderr=true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --logtostderr=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-signing-duration=87600h0m0s
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --v=2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>创建目录</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /data/logs/kubernetes/kube-controller-manager
</span></span></code></pre></div><h5 id="启动-2">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kube-controller-manager.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kube-controller-manager.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kube-controller-manager.service
</span></span></code></pre></div><h4 id="kube-scheduler配置">kube-scheduler配置</h4>
<h5 id="生成kubeconfig证书用于tls认证-1">生成kubeconfig证书(用于TLS认证)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置集群参数</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#000;font-weight:bold">=</span>ca.pem --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --server<span style="color:#000;font-weight:bold">=</span>https://10.0.26.180:6443 --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置客户端认证参数</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials system:kube-scheduler --client-certificate<span style="color:#000;font-weight:bold">=</span>kube-scheduler.pem --client-key<span style="color:#000;font-weight:bold">=</span>kube-scheduler-key.pem --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置上下文参数</span>
</span></span><span style="display:flex;"><span>kubectl config set-context system:kube-scheduler --cluster<span style="color:#000;font-weight:bold">=</span>kubernetes --user<span style="color:#000;font-weight:bold">=</span>system:kube-scheduler --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置默认上下文</span>
</span></span><span style="display:flex;"><span>kubectl config use-context system:kube-scheduler --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-scheduler.kubeconfig
</span></span></code></pre></div><h5 id="systemd服务单元配置-3">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kube-scheduler.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes Scheduler Plugin
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/kubernetes/server/bin/kube-scheduler $DAEMON_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-3">配置启动依赖</h5>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/kubernetes/scheduler <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">DAEMON_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --bind-address=127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --leader-elect=true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --log-dir=/data/logs/kubernetes/kube-scheduler
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubeconfig=/etc/kubernetes/pki/kube-scheduler.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-cert-file=/etc/kubernetes/pki/kube-scheduler.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-private-key-file=/etc/kubernetes/pki/kube-scheduler-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --v=2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>创建目录</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /data/logs/kubernetes/kube-scheduler
</span></span></code></pre></div><h5 id="启动-3">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kube-scheduler.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kube-scheduler.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kube-scheduler.service
</span></span></code></pre></div><h4 id="kubectl配置">kubectl配置</h4>
<h5 id="生成kubeconfig证书用于tls认证-2">生成kubeconfig证书(用于TLS认证)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置集群参数</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#000;font-weight:bold">=</span>ca.pem --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --server<span style="color:#000;font-weight:bold">=</span>https://10.0.26.180:6443 --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube.config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置客户端认证参数</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials admin --client-certificate<span style="color:#000;font-weight:bold">=</span>admin.pem --client-key<span style="color:#000;font-weight:bold">=</span>admin-key.pem --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube.config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置上下文参数</span>
</span></span><span style="display:flex;"><span>kubectl config set-context kubernetes --cluster<span style="color:#000;font-weight:bold">=</span>kubernetes --user<span style="color:#000;font-weight:bold">=</span>admin --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube.config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置默认上下文</span>
</span></span><span style="display:flex;"><span>kubectl config use-context kubernetes --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube.config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 复制配置文件</span>
</span></span><span style="display:flex;"><span>mkdir ~/.kube
</span></span><span style="display:flex;"><span>cp kube.config ~/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 授权 k8s-node 用户访问kubelet api权限</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl exec报错的话，则需要删除重建</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># error: unable to upgrade connection: Forbidden (user=kubernetes, verb=create, resource=nodes, subresource=proxy)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl delete clusterrolebinding kube-apiserver:kubelet-apis</span>
</span></span><span style="display:flex;"><span>kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole<span style="color:#000;font-weight:bold">=</span>system:kubelet-api-admin --user k8s-node
</span></span></code></pre></div><h5 id="kubectl自动补全">kubectl自动补全</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># yum install -y bash-completion</span>
</span></span><span style="display:flex;"><span>grep -q kubectl ~/.bashrc <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; ~/.bashrc <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># .bashrc
</span></span></span><span style="display:flex;"><span><span style="color:#d14">source &lt;(kubectl completion bash)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 加载</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">source</span> ~/.bashrc
</span></span></code></pre></div><h5 id="检查主控节点状态">检查主控节点状态</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get cs
</span></span><span style="display:flex;"><span>kubectl cluster-info
</span></span></code></pre></div><h4 id="dashboard">dashboard</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 部署 Dashboard UI</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 暴露端口，修改type: ClusterIP-&gt;type: NodePort</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl -n kubernetes-dashboard edit service kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看生效(获取端口)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl -n kubernetes-dashboard get service kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>kubectl get pods,svc -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 授权</span>
</span></span><span style="display:flex;"><span>kubectl create serviceaccount dashboard-admin -n kube-system
</span></span><span style="display:flex;"><span>kubectl create clusterrolebinding dashboard-admin --clusterrole<span style="color:#000;font-weight:bold">=</span>cluster-admin --serviceaccount<span style="color:#000;font-weight:bold">=</span>kube-system:dashboard-admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看 token</span>
</span></span><span style="display:flex;"><span>kubectl describe secrets -n kube-system <span style="color:#000;font-weight:bold">$(</span>kubectl -n kube-system get secret | awk <span style="color:#d14">&#39;/dashboard-admin/{print $1}&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 访问</span>
</span></span><span style="display:flex;"><span>https://10.0.26.180:31709/
</span></span></code></pre></div><h2 id="node各个组件安装">node各个组件安装</h2>
<blockquote>
<p>flannel、docker、 kubelet、kube-proxy</p>
</blockquote>
<h3 id="环境准备-1">环境准备</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostnamectl set-hostname k8s-node-01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -q k8s-master-01 /etc/hosts <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; /etc/hosts <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.180 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.190 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.191 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启桥接功能</span>
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>cat &gt; /etc/sysctl.d/k8s.conf <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></div><h4 id="证书准备-1">证书准备</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 证书中心下载(master)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cd /etc/kubernetes/pki &amp;&amp; sz -b ca.pem kubelet*.pem client*.pem</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># node</span>
</span></span><span style="display:flex;"><span>mkdir -pv /etc/kubernetes/pki
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>rz -b
</span></span></code></pre></div><h3 id="安装flannel">安装flannel</h3>
<blockquote>
<p>实现跨主机的Pod可以互通</p>
</blockquote>
<h4 id="下载安裝">下载安裝</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src/
</span></span><span style="display:flex;"><span>wget https://github.com/flannel-io/flannel/releases/download/v0.13.0/flannel-v0.13.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -f /usr/local/flannel/flanneld <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>mkdir -pv /usr/local/flannel <span style="color:#000;font-weight:bold">&amp;&amp;</span> tar xzvf flannel-v0.13.0-linux-amd64.tar.gz -C /usr/local/flannel/<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="运行原理">运行原理</h4>
<blockquote>
<p>flanneld 优先读取 &ndash;subnet-file 参数定义的配置文件，如果不存在则读取 etcd 配置的网络信息，随机生成子网到 &ndash;subnet-file=/etc/kubernetes/flanneld_subnet.env，内容如下：</p>
<p>FLANNEL_NETWORK=172.26.0.0/16
FLANNEL_SUBNET=172.26.25.1/24
FLANNEL_MTU=1500
FLANNEL_IPMASQ=false</p>
<p>为了自定义FLANNEL_SUBNET，可以手动生成flanneld_subnet.env,但是最大的问题是，如果FLANNEL_SUBNET冲突，会导致服务器被顶替，所以建议自动生成？</p>
<p>mk-docker-opts.sh：读取  /run/flannel/subnet.env  文件生成  /run/docker_opts.env，其实就是参数转换
参数 -k DOCKER_NETWORK_OPTIONS (用于声明参数名称)，最终生成：DOCKER_NETWORK_OPTIONS =&quot; &ndash;bip=172.33.68.1/24 &ndash;ip-masq=true &ndash;mtu=1500&quot;
dockerd 追加 $DOCKER_NETWORK_OPTIONS  即可</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /usr/local/flannel/flanneld --help|less</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --etcd-prefix etcd prefix (default &#34;/coreos.com/network&#34;) 默认注册地址</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --iface 为当前宿主机对外网卡</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --public-ip 为本机IP</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --subnet-file 指定网络配置</span>
</span></span></code></pre></div><h4 id="systemd服务单元配置-4">systemd服务单元配置</h4>
<blockquote>
<p>RequiredBy=docker.service 代表docker依赖此服务</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/flanneld.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=flannel - Network fabric for containers (System Application Container)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/coreos/flannel
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=etcd.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Before=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#d14">RestartSec=10s
</span></span></span><span style="display:flex;"><span><span style="color:#d14">TimeoutStartSec=300
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=40000
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNPROC=1048576
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/flanneld
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/flannel/flanneld $FLANNEL_OPTIONS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStartPost=/usr/local/flannel/mk-docker-opts.sh -f /etc/kubernetes/flanneld_subnet.env -k DOCKER_NETWORK_OPTIONS -d /etc/kubernetes/flanneld_docker.env
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">RequiredBy=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="配置说明">配置说明</h4>
<p>注意：各个机器上bip网段不一致，bip中间两段与宿主机最后两段相同，目的是方便定位问题。bip根据宿主机ip变化 ：</p>
<p>bip 172.<code>26.180</code>.1/24   对应：10.0.<code>26.180</code></p>
<p>bip 172.<code>26.190</code>.1/24   对应：10.0.<code>26.190</code></p>
<p>bip 172.<code>26.191</code>.1/24   对应：10.0.<code>26.191</code></p>
<h4 id="配置启动依赖-4">配置启动依赖</h4>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意修改：public-ip、iface</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/flanneld <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_OPTIONS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --public-ip=10.0.26.190
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --iface=enp0s3
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --healthz-port=2401
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-endpoints=https://10.0.26.180:2379
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-keyfile=/etc/kubernetes/pki/client-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-certfile=/etc/kubernetes/pki/client.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-cafile=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --subnet-file=/etc/kubernetes/flanneld_subnet.env
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>flanneld网络配置文件，为了自定义子网，手动生成此文件即可</p>
<p>如果冲突的话，PublicIP会被顶替到，所以自动生成是不是最好的选择呢？查看方法：</p>
<p>etcdctl2 get /coreos.com/network/subnets/172.26.190.0-24</p>
<p>服务器ip后两位 对应 172中间两位： 10.0.<code>26.190</code> ==&gt; 172.<code>26.190</code>.1/24</p>
<p>FLANNEL_NETWORK：10.0.<code>26</code>.187 ==&gt; 172.<code>26</code>.0.0/16</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议 flanneld 通过读取etcd后，自动分配网段</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/flanneld_subnet.env <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_NETWORK=172.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_SUBNET=172.26.190.1/24
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_MTU=1500
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_IPMASQ=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>flanneld etcd依赖数据(master)</p>
<p>执行一次即可</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 这里需要完整路径，否者etcdctl会被解析成alias的etcdctl</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># alias etcdctl2=&#39;ETCDCTL_API=2 /usr/bin/etcdctl --ca-file=/etc/kubernetes/pki/ca.pem --cert-file=/etc/kubernetes/pki/etcd-peer.pem --key-file=/etc/kubernetes/pki/etcd-peer-key.pem --endpoints=https://10.0.26.180:2379&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 设置网络及后端类型</span>
</span></span><span style="display:flex;"><span>etcdctl2 <span style="color:#0086b3">set</span> /coreos.com/network/config <span style="color:#d14">&#39;{&#34;Network&#34;: &#34;172.26.0.0/16&#34;, &#34;Backend&#34;: {&#34;Type&#34;: &#34;host-gw&#34;}}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看数据</span>
</span></span><span style="display:flex;"><span>etcdctl2 get /coreos.com/network/config
</span></span><span style="display:flex;"><span>etcdctl2 ls /coreos.com/network/subnets
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 删除</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># etcdctl2 rm /coreos.com/network/subnets/172.26.25.0-24</span>
</span></span></code></pre></div><h4 id="启动-4">启动</h4>
<blockquote>
<p>启动的时候实际上只是添加了本地的防火墙FORWARD的权限和生成/etc/kubernetes/flanneld_docker.env</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> flanneld.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start flanneld.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status flanneld.service
</span></span></code></pre></div><h3 id="安装docker">安装docker</h3>
<h4 id="下载安装-1">下载安装</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># https://download.docker.com/linux/static/stable/x86_64/</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src
</span></span><span style="display:flex;"><span>wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.6.tgz
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -f /usr/bin/docker <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>tar xzf docker-20.10.6.tgz <span style="color:#000;font-weight:bold">&amp;&amp;</span> cp -v docker/* /usr/bin/<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="systemd服务单元配置-5">systemd服务单元配置</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/docker.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Docker Application Container Engine
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://docs.docker.com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network-online.target firewalld.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/flanneld_docker.env
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecReload=/bin/kill -s HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNPROC=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitCORE=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#d14">TimeoutStartSec=0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Delegate=yes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KillMode=process
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">StartLimitBurst=3
</span></span></span><span style="display:flex;"><span><span style="color:#d14">StartLimitInterval=60s
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="配置启动依赖-5">配置启动依赖</h4>
<blockquote>
<p>配置文件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /etc/docker /data/docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># bip 通过 $DOCKER_NETWORK_OPTIONS 读取</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/docker/daemon.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;graph&#34;: &#34;/data/docker&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;registry-mirrors&#34;: [&#34;https://registry.docker-cn.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;live-restore&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="启动-5">启动</h4>
<blockquote>
<p>修改配置文件后：systemctl daemon-reload</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看状态</span>
</span></span><span style="display:flex;"><span>systemctl status docker
</span></span></code></pre></div><h4 id="状态检测-1">状态检测</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检查启动情况</span>
</span></span><span style="display:flex;"><span>docker -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检查网络</span>
</span></span><span style="display:flex;"><span>ip a |grep docker0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看容器运行是否符合配置</span>
</span></span><span style="display:flex;"><span>docker pull busybox
</span></span><span style="display:flex;"><span>docker run -it --rm busybox /bin/sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ <span style="color:#998;font-style:italic"># ip add</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 容器IP为172.26.190.2，符合设置。这样，根据容器ip就可以很容易定位到容器所属主机节点。</span>
</span></span></code></pre></div><h3 id="kubernetes-node">kubernetes-node</h3>
<h4 id="下载安装-2">下载安装</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src/
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/v1.21.1/kubernetes-node-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -d /usr/local/kubernetes <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> tar xzvf kubernetes-node-linux-amd64.tar.gz -C /usr/local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建软连接</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -f /usr/bin/kubectl <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> ln -sv /usr/local/kubernetes/node/bin/kube* /usr/bin/
</span></span></code></pre></div><h4 id="kubelet配置">kubelet配置</h4>
<h5 id="配置kubeconfigmaster">配置kubeconfig(master)</h5>
<blockquote>
<p>在master上面配置，方便所有节点同步</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># set-cluster** 创建需要连接的集群信息，可以创建多个k8s集群信息</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>kubectl config set-cluster myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --certificate-authority<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --server<span style="color:#000;font-weight:bold">=</span>https://10.0.26.180:6443 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/kubelet.kubeconfig
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># set-credentials**  创建用户账号，即用户登陆使用的客户端私有和证书，可以创建多个证书</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials k8s-node <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --client-certificate<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --client-key<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># set-context**  设置context，即确定账号和集群对应关系</span>
</span></span><span style="display:flex;"><span>kubectl config set-context myk8s-context --cluster<span style="color:#000;font-weight:bold">=</span>myk8s --user<span style="color:#000;font-weight:bold">=</span>k8s-node  --kubeconfig<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/kubelet.kubeconfig
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># use-context**  设置当前使用哪个context</span>
</span></span><span style="display:flex;"><span>kubectl config use-context myk8s-context --kubeconfig<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 拷贝kube-proxy.kubeconfig 到 node的目录下</span>
</span></span><span style="display:flex;"><span>sz -b kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># node</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki <span style="color:#000;font-weight:bold">&amp;&amp;</span> rz -b
</span></span></code></pre></div><h5 id="授权k8s-node用户master上操作">授权k8s-node用户（master上操作）</h5>
<blockquote>
<p>授权k8s-node用户绑定集群角色 system:node ，让 k8s-node 成为具备运算节点的权限。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes
</span></span><span style="display:flex;"><span>cat &gt; k8s-node.yaml <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">apiVersion: rbac.authorization.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">kind: ClusterRoleBinding
</span></span></span><span style="display:flex;"><span><span style="color:#d14">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  name: k8s-node
</span></span></span><span style="display:flex;"><span><span style="color:#d14">roleRef:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  kind: ClusterRole
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  name: system:node
</span></span></span><span style="display:flex;"><span><span style="color:#d14">subjects:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">- apiGroup: rbac.authorization.k8s.io
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  kind: User
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  name: k8s-node
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>应用资源配置文件，并检查</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 应用</span>
</span></span><span style="display:flex;"><span>kubectl apply -f k8s-node.yaml
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># clusterrolebinding.rbac.authorization.k8s.io/k8s-node created</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看</span>
</span></span><span style="display:flex;"><span>kubectl get clusterrolebinding k8s-node
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># NAME       ROLE                      AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># k8s-node   ClusterRole/system:node   17s</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看</span>
</span></span><span style="display:flex;"><span>kubectl get clusterrolebinding k8s-node -o yaml
</span></span></code></pre></div><h5 id="systemd服务单元配置-6">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kubelet.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes Kubelet Server
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Requires=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WorkingDirectory=/data/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/bin/kubelet $KUBELET_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-6">配置启动依赖</h5>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/kubernetes/kubelet <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KUBELET_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --anonymous-auth=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cgroup-driver systemd
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-dns 10.26.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-domain cluster.local
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --runtime-cgroups=/systemd/system.slice
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubelet-cgroups=/systemd/system.slice
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --fail-swap-on=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --client-ca-file /etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-cert-file /etc/kubernetes/pki/kubelet.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-private-key-file /etc/kubernetes/pki/kubelet-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --hostname-override 10.0.26.190
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --image-gc-high-threshold 20
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --image-gc-low-threshold 10
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubeconfig /etc/kubernetes/pki/kubelet.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --log-dir /data/logs/kubernetes/kube-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --pod-infra-container-image kubernetes/pause:latest
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --root-dir /data/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --authorization-mode Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>准备pause基础镜像，kubelet启动依赖
一切运行时都是基于这个上面的(不安装的话，kubelet将无法正常启动)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull kubernetes/pause
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 新增tag：k8s.gcr.io/pause:3.4.1</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建pod的时候拉取的k8s.gcr.io/pause:3.4.1镜像</span>
</span></span><span style="display:flex;"><span>docker tag kubernetes/pause:latest k8s.gcr.io/pause:3.4.1
</span></span><span style="display:flex;"><span>docker images
</span></span></code></pre></div><blockquote>
<p>创建目录</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /data/logs/kubernetes/kube-kubelet /data/kubelet
</span></span></code></pre></div><h5 id="启动-6">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看日志</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># journalctl -xeu kubelet</span>
</span></span></code></pre></div><h5 id="验证节点是否加入master">验证节点是否加入(master)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看节点信息是否加入(加入节点需要一定的时间)</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>kubectl get nodes -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 打标签</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node-01 node-role.kubernetes.io/node<span style="color:#000;font-weight:bold">=</span>node/10.0.26.191 labeled
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node-01 node-role.kubernetes.io/worker<span style="color:#000;font-weight:bold">=</span>node/10.0.26.191 labeled
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><h4 id="kube-proxy配置">kube-proxy配置</h4>
<h5 id="配置kubeconfigmaster生成">配置kubeconfig(master生成)</h5>
<blockquote>
<p>master方便所有节点同步</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>kubectl config set-cluster myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--certificate-authority<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--server<span style="color:#000;font-weight:bold">=</span>https://10.0.26.180:6443 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials kube-proxy <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --client-certificate<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/kube-proxy-client.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --client-key<span style="color:#000;font-weight:bold">=</span>/etc/kubernetes/pki/kube-proxy-client-key.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --embed-certs<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context myk8s-context <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--cluster<span style="color:#000;font-weight:bold">=</span>myk8s <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--user<span style="color:#000;font-weight:bold">=</span>kube-proxy <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>--kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context myk8s-context --kubeconfig<span style="color:#000;font-weight:bold">=</span>kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 拷贝kube-proxy.kubeconfig 到 node的目录下</span>
</span></span><span style="display:flex;"><span>sz -b kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># node</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki <span style="color:#000;font-weight:bold">&amp;&amp;</span> rz -b
</span></span></code></pre></div><h5 id="systemd服务单元配置-7">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kube-proxy.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes Kube-Proxy Server
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStartPre=bash /etc/kubernetes/ipvs.sh
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/kubernetes/node/bin/kube-proxy $KUBE_PROXY_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-7">配置启动依赖</h5>
<p>注：kube-proxy共有3种流量调度模式，分别是 namespace，iptables，ipvs，其中ipvs性能最好。这里设置<code>ipvs</code>，如果不设置则使用<code>iptables</code></p>
<blockquote>
<p>安装依赖包</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt-get -y install ipset ipvsadm
</span></span></code></pre></div><blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/kubernetes/proxy <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KUBE_PROXY_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-cidr 172.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --bind-address 10.0.26.191
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --hostname-override 10.0.26.190
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --proxy-mode=ipvs
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --ipvs-scheduler=nq
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubeconfig /etc/kubernetes/pki/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>加载ipvs模块</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lsmod | grep ip_vs_nq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 加载脚本（关键模块：ip_vs_nq）</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/ipvs.sh <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ipvs_mods_dir=&#34;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">for i in $(ls $ipvs_mods_dir|grep -o &#34;^[^.]*&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">do
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  /sbin/modinfo -F filename $i &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    /sbin/modprobe $i
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  fi
</span></span></span><span style="display:flex;"><span><span style="color:#d14">done
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 执行加载(配置到kube-proxy.service进行自动加载) </span>
</span></span><span style="display:flex;"><span>bash /etc/kubernetes/ipvs.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看(多了很多)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动报错：Can&#39;t use the IPVS proxier: error getting ipset version, error: executable file not found in $PATH</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># apt-get install ipset ipvsadm</span>
</span></span><span style="display:flex;"><span>lsmod | grep ip_vs_nq
</span></span></code></pre></div><h5 id="启动-7">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kube-proxy.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kube-proxy.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kube-proxy.service
</span></span></code></pre></div><h5 id="状态检查">状态检查</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@k8s-node-01:~# ipvsadm -Ln
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># IP Virtual Server version 1.2.1 (size=4096)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Prot LocalAddress:Port Scheduler Flags</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#   -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># TCP  10.26.0.1:443 nq</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#   -&gt; 10.0.26.180:6443              Masq    1      0          0      </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kube-proxy启动日志关键字：Using ipvs Proxier.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># I0520 14:43:34.790409    9233 server_others.go:274] Using ipvs Proxier.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># master查看svc</span>
</span></span><span style="display:flex;"><span>kubectl get svc
</span></span></code></pre></div><h2 id="验证">验证</h2>
<h3 id="查看节点是否加入">查看节点是否加入</h3>
<blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl describe nodes k8s-node-01
</span></span></code></pre></div></blockquote>
<h3 id="创建pod和service进行测试master">创建pod和service进行测试(master)</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir ~/k8s-test
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> ~/k8s-test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成配置？</span>
</span></span><span style="display:flex;"><span>kubectl run pod-ng --image<span style="color:#000;font-weight:bold">=</span>nginx:stable --dry-run<span style="color:#000;font-weight:bold">=</span>client -o yaml &gt; pod-ng.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加镜像拉取策略：imagePullPolicy: IfNotPresent</span>
</span></span><span style="display:flex;"><span>vim pod-ng.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#  - image: nginx:stable</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    name: pod-ng</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 应用策略</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 会自动下载相关镜像</span>
</span></span><span style="display:flex;"><span>kubectl apply -f pod-ng.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看容器状态</span>
</span></span><span style="display:flex;"><span>kubectl get pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ContainerCreating，Pending状态具体查看</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看最后的Events即可（即：整个创建流程）</span>
</span></span><span style="display:flex;"><span>kubectl describe pod pod-ng
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 重新启动容器</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># https://segmentfault.com/a/1190000020675199</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl get pod {podname} -n {namespace} -o yaml | kubectl replace --force -f -</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl get pod pod-ng -n default -o yaml | kubectl replace --force -f -</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看容器IP信息</span>
</span></span><span style="display:flex;"><span>kubectl get pod -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># svc-ng(快速创建service)</span>
</span></span><span style="display:flex;"><span>kubectl expose pod pod-ng --name<span style="color:#000;font-weight:bold">=</span>svc-ng --port<span style="color:#000;font-weight:bold">=</span><span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看 CLUSTER-IP</span>
</span></span><span style="display:flex;"><span>kubectl get svc svc-ng
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># node上访问测试，IP获取(kubectl get pod -o wide)</span>
</span></span><span style="display:flex;"><span>curl -I 172.26.190.2
</span></span></code></pre></div><h2 id="新节点加入">新节点加入</h2>
<blockquote>
<p>组件：docker、 kubelet、kube-proxy</p>
<p>191为例</p>
</blockquote>
<h3 id="kubelet证书刷新">kubelet证书刷新</h3>
<blockquote>
<p>hosts新增10.0.26.191，并重新生成证书</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubelet证书请求文件</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意主机列表，有新增ip则重新生成即可</span>
</span></span><span style="display:flex;"><span>cat &gt; kubelet-csr.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;CN&#34;: &#34;k8s-kubelet&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;hosts&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;127.0.0.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.180&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.190&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;10.0.26.191&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    },
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;ST&#34;: &#34;SiChuan&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;L&#34;: &#34;ChengDu&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;O&#34;: &#34;Internet Zaza Ltd&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">            &#34;OU&#34;: &#34;IT&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成证书(需要拷贝到每个node节点)</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#000;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#000;font-weight:bold">=</span>ca-key.pem -config<span style="color:#000;font-weight:bold">=</span>ca-config.json -profile<span style="color:#000;font-weight:bold">=</span>server kubelet-csr.json | cfssljson -bare kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 更新kubelet证书信息</span>
</span></span><span style="display:flex;"><span>sz -b kubelet.pem kubelet-key.pem
</span></span></code></pre></div><h3 id="同步pki目录文件">同步pki目录文件</h3>
<blockquote>
<p>列表如下</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 证书中心下载(master)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cd /etc/kubernetes/pki &amp;&amp; sz -b ca.pem kubelet*.pem client*.pem</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 节点上传</span>
</span></span><span style="display:flex;"><span>mkdir -pv /etc/kubernetes/pki
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>rz -b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># root@k8s-node-02:/etc/kubernetes/pki# ll</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># total 44</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># drwxr-xr-x 2 root root 4096 May 26 09:06 ./</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># drwxr-xr-x 3 root root 4096 May 26 08:59 ../</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 1342 May 25 08:29 ca.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 1679 May 25 08:29 client-key.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 1407 May 25 08:29 client.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 1675 May 26 08:50 kubelet-key.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 6252 May 25 08:43 kubelet.kubeconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 1476 May 26 08:50 kubelet.pem</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># -rw-r--r-- 1 root root 6272 May 25 08:45 kube-proxy.kubeconfig</span>
</span></span></code></pre></div><h3 id="环境准备-2">环境准备</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hostnamectl set-hostname k8s-node-02
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -q k8s-master-01 /etc/hosts <span style="color:#000;font-weight:bold">||</span> cat &gt;&gt; /etc/hosts <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.180 k8s-master-01
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.191 k8s-node-01
</span></span></span><span style="display:flex;"><span><span style="color:#d14">10.0.26.190 k8s-node-02
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启桥接功能</span>
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>cat &gt; /etc/sysctl.d/k8s.conf <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sysctl -p /etc/sysctl.d/k8s.conf
</span></span></code></pre></div><h3 id="安装flannel-1">安装flannel</h3>
<blockquote>
<p>flannel：跨主机的Pod可以互通</p>
</blockquote>
<h4 id="下载安裝-1">下载安裝</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src/
</span></span><span style="display:flex;"><span>wget https://github.com/flannel-io/flannel/releases/download/v0.13.0/flannel-v0.13.0-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -f /usr/local/flannel/flanneld <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>mkdir -pv /usr/local/flannel <span style="color:#000;font-weight:bold">&amp;&amp;</span> tar xzvf flannel-v0.13.0-linux-amd64.tar.gz -C /usr/local/flannel/<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="systemd服务单元配置-8">systemd服务单元配置</h4>
<blockquote>
<p>RequiredBy=docker.service 代表docker依赖此服务</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/flanneld.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=flannel - Network fabric for containers (System Application Container)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/coreos/flannel
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=etcd.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Before=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#d14">RestartSec=10s
</span></span></span><span style="display:flex;"><span><span style="color:#d14">TimeoutStartSec=300
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=40000
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNPROC=1048576
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/flanneld
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/flannel/flanneld $FLANNEL_OPTIONS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStartPost=/usr/local/flannel/mk-docker-opts.sh -f /etc/kubernetes/flanneld_subnet.env -k DOCKER_NETWORK_OPTIONS -d /etc/kubernetes/flanneld_docker.env
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">RequiredBy=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="配置说明-1">配置说明</h4>
<p>注意：各个机器上bip网段不一致，bip中间两段与宿主机最后两段相同，目的是方便定位问题。bip根据宿主机ip变化 ：</p>
<p>bip 172.<code>26.191</code>.1/24   对应：10.0.<code>26.191</code></p>
<h4 id="配置启动依赖-8">配置启动依赖</h4>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意修改：public-ip、iface</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/flanneld <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_OPTIONS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --public-ip=10.0.26.191
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --iface=enp0s3
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --healthz-port=2401
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-endpoints=https://10.0.26.180:2379
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-keyfile=/etc/kubernetes/pki/client-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-certfile=/etc/kubernetes/pki/client.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --etcd-cafile=/etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --subnet-file=/etc/kubernetes/flanneld_subnet.env
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>flanneld网络配置文件，为了自定义子网，手动生成此文件即可</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议 flanneld 通过读取etcd后，自动分配网段</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/flanneld_subnet.env <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_NETWORK=172.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_SUBNET=172.26.191.1/24
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_MTU=1500
</span></span></span><span style="display:flex;"><span><span style="color:#d14">FLANNEL_IPMASQ=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="启动-8">启动</h4>
<blockquote>
<p>启动的时候实际上只是添加了本地的防火墙 FORWARD 的权限和生成 /etc/kubernetes/flanneld_docker.env</p>
<p>root@k8s-node-02:/usr/local/src# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.26.1        0.0.0.0         UG    0      0        0 enp0s3
10.0.26.0        0.0.0.0         255.255.255.0   U     0      0        0 enp0s3
172.26.190.0     10.0.26.190      255.255.255.0   UG    0      0        0 enp0s3 # 会自动新增其它节点路由信息</p>
<p>root@k8s-node-01:/etc/kubernetes/pki# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.26.1        0.0.0.0         UG    0      0        0 enp0s3
10.0.26.0        0.0.0.0         255.255.255.0   U     0      0        0 enp0s3
172.26.190.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0
172.26.191.0     10.0.26.191      255.255.255.0   UG    0      0        0 enp0s3 # 会自动新增其它节点路由信息</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> flanneld.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start flanneld.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status flanneld.service
</span></span></code></pre></div><h3 id="安装docker-1">安装docker</h3>
<h4 id="下载安装-3">下载安装</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># https://download.docker.com/linux/static/stable/x86_64/</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src
</span></span><span style="display:flex;"><span>wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.6.tgz
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -f /usr/bin/docker <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>tar xzf docker-20.10.6.tgz <span style="color:#000;font-weight:bold">&amp;&amp;</span> cp -v docker/* /usr/bin/<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="配置">配置</h4>
<p>注意：各个机器上bip网段不一致，bip中间两段与宿主机最后两段相同，目的是方便定位问题。bip根据宿主机ip变化 ：</p>
<p>bip 172.<code>26.191</code>.1/24   对应：10.0.<code>26.191</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /etc/docker /data/docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意修改bip</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># dockerd读取的默认配置文件：/etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/docker/daemon.json <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">{
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;graph&#34;: &#34;/data/docker&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;registry-mirrors&#34;: [&#34;https://registry.docker-cn.com&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  &#34;live-restore&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="systemd服务单元配置-9">systemd服务单元配置</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/docker.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Docker Application Container Engine
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://docs.docker.com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network-online.target firewalld.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Type=notify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/flanneld_docker.env
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecReload=/bin/kill -s HUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNPROC=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitCORE=infinity
</span></span></span><span style="display:flex;"><span><span style="color:#d14">TimeoutStartSec=0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Delegate=yes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KillMode=process
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">StartLimitBurst=3
</span></span></span><span style="display:flex;"><span><span style="color:#d14">StartLimitInterval=60s
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="启动-9">启动</h4>
<blockquote>
<p>修改配置文件后：systemctl daemon-reload</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看状态</span>
</span></span><span style="display:flex;"><span>systemctl status docker
</span></span></code></pre></div><h4 id="状态检测-2">状态检测</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检查启动情况</span>
</span></span><span style="display:flex;"><span>docker -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检查网络</span>
</span></span><span style="display:flex;"><span>ip a |grep docker0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看容器运行是否符合配置</span>
</span></span><span style="display:flex;"><span>docker pull busybox
</span></span><span style="display:flex;"><span>docker run -it --rm busybox /bin/sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/ <span style="color:#998;font-style:italic"># ip add</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 容器IP为172.26.191.2，符合设置。这样，根据容器ip就可以很容易定位到容器所属主机节点。</span>
</span></span></code></pre></div><h3 id="kubernetes-node-1">kubernetes-node</h3>
<h4 id="下载安装-4">下载安装</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src/
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/v1.21.1/kubernetes-node-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -d /usr/local/kubernetes <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> tar xzvf kubernetes-node-linux-amd64.tar.gz -C /usr/local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建软连接</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> -f /usr/bin/kubectl <span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> ln -sv /usr/local/kubernetes/node/bin/kube* /usr/bin/
</span></span></code></pre></div><h4 id="kubelet配置-1">kubelet配置</h4>
<h5 id="systemd服务单元配置-10">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kubelet.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes Kubelet Server
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Requires=docker.service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WorkingDirectory=/data/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/bin/kubelet $KUBELET_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-9">配置启动依赖</h5>
<blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意修改：hostname-override的ip</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/kubelet <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KUBELET_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --anonymous-auth=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cgroup-driver systemd
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-dns 10.26.0.2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-domain cluster.local
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --runtime-cgroups=/systemd/system.slice
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubelet-cgroups=/systemd/system.slice
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --fail-swap-on=false
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --client-ca-file /etc/kubernetes/pki/ca.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-cert-file /etc/kubernetes/pki/kubelet.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --tls-private-key-file /etc/kubernetes/pki/kubelet-key.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --hostname-override 10.0.26.191
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --image-gc-high-threshold 20
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --image-gc-low-threshold 10
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubeconfig /etc/kubernetes/pki/kubelet.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --log-dir /data/logs/kubernetes/kube-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --pod-infra-container-image kubernetes/pause:latest
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --root-dir /data/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --authorization-mode Webhook
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>准备pause基础镜像，kubelet启动依赖
一切运行时都是基于这个上面的(不安装的话，kubelet将无法正常启动)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull kubernetes/pause
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 新增tag：k8s.gcr.io/pause:3.4.1</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建pod的时候拉取的k8s.gcr.io/pause:3.4.1镜像</span>
</span></span><span style="display:flex;"><span>docker tag kubernetes/pause:latest k8s.gcr.io/pause:3.4.1
</span></span><span style="display:flex;"><span>docker images
</span></span></code></pre></div><blockquote>
<p>创建目录</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -pv /data/logs/kubernetes/kube-kubelet /data/kubelet
</span></span></code></pre></div><h5 id="启动-10">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kubelet.service
</span></span></code></pre></div><h5 id="验证节点是否加入master-1">验证节点是否加入(master)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看节点信息是否加入(加入节点需要一定的时间)</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>kubectl get nodes -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 打标签</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node-01 node-role.kubernetes.io/node<span style="color:#000;font-weight:bold">=</span>node/10.0.26.191 labeled
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node-01 node-role.kubernetes.io/worker<span style="color:#000;font-weight:bold">=</span>node/10.0.26.191 labeled
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><h4 id="kube-proxy配置-1">kube-proxy配置</h4>
<h5 id="systemd服务单元配置-11">systemd服务单元配置</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kube-proxy.service <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Description=Kubernetes Kube-Proxy Server
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#d14">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EnvironmentFile=-/etc/kubernetes/proxy
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStartPre=bash /etc/kubernetes/ipvs.sh
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ExecStart=/usr/local/kubernetes/node/bin/kube-proxy $KUBE_PROXY_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#d14">LimitNOFILE=65536
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h5 id="配置启动依赖-10">配置启动依赖</h5>
<blockquote>
<p>安装依赖包</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt-get -y install ipset ipvsadm
</span></span></code></pre></div><blockquote>
<p>环境参数文件(参数里面不要有双引号，否则数据会被截断)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意修改bind-address和hostname-override</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/proxy <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">KUBE_PROXY_ARGS=&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --cluster-cidr 172.26.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --bind-address 10.0.26.191
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --hostname-override 10.0.26.191
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --proxy-mode=ipvs
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --ipvs-scheduler=nq
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  --kubeconfig /etc/kubernetes/pki/kube-proxy.kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><blockquote>
<p>加载ipvs模块</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>lsmod | grep ip_vs_nq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 加载脚本（关键模块：ip_vs_nq）</span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/kubernetes/ipvs.sh <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ipvs_mods_dir=&#34;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">for i in $(ls $ipvs_mods_dir|grep -o &#34;^[^.]*&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">do
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  /sbin/modinfo -F filename $i &amp;&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  if [ $? -eq 0 ];then
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    /sbin/modprobe $i
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  fi
</span></span></span><span style="display:flex;"><span><span style="color:#d14">done
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 执行加载(放在ExecStartPre) </span>
</span></span><span style="display:flex;"><span>bash /etc/kubernetes/ipvs.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看(多了很多)</span>
</span></span><span style="display:flex;"><span>lsmod | grep ip_vs_nq
</span></span></code></pre></div><h5 id="启动-11">启动</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开机自启动</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#0086b3">enable</span> kube-proxy.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start kube-proxy.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 检测状态</span>
</span></span><span style="display:flex;"><span>systemctl status kube-proxy.service
</span></span></code></pre></div><h5 id="验证master">验证(master)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看节点信息是否是：Ready状态，这个状态需要一小段时间进行同步</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成配置</span>
</span></span><span style="display:flex;"><span>cat &gt; ~/k8s-test/nginx-deployment.yaml <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#d14">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  name: nginx-deployment
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  labels:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#d14">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  replicas: 2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    matchLabels:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  template:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      labels:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    spec:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      containers:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">      - name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        image: nginx:stable
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        ports:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        - containerPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建一个deployment</span>
</span></span><span style="display:flex;"><span>kubectl apply -f ~/k8s-test/nginx-deployment.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看进度状态</span>
</span></span><span style="display:flex;"><span>kubectl get pods
</span></span><span style="display:flex;"><span>kubectl get rs
</span></span><span style="display:flex;"><span>kubectl get deployment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建service</span>
</span></span><span style="display:flex;"><span>kubectl expose deployments.apps/nginx-deployment --port<span style="color:#000;font-weight:bold">=</span><span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看 CLUSTER-IP</span>
</span></span><span style="display:flex;"><span>kubectl get svc nginx-deployment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 任意node上访问测试，IP获取(kubectl get pod -o wide)</span>
</span></span><span style="display:flex;"><span>curl -I 172.26.190.2
</span></span><span style="display:flex;"><span>curl -I 172.26.191.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 任意node上访问测试通过，代表 flannel 路由已经正常</span>
</span></span><span style="display:flex;"><span>etcdctl2 ls /coreos.com/network/subnets
</span></span><span style="display:flex;"><span>etcdctl2 get /coreos.com/network/subnets/172.26.190.0-24
</span></span><span style="display:flex;"><span>etcdctl2 get /coreos.com/network/subnets/172.26.191.0-24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加 node 主机层端口</span>
</span></span><span style="display:flex;"><span>cat &gt; ~/k8s-test/nginx-deployment-svc.yaml <span style="color:#d14">&lt;&lt; &#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">kind: Service
</span></span></span><span style="display:flex;"><span><span style="color:#d14">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  name: nginx-deployment
</span></span></span><span style="display:flex;"><span><span style="color:#d14">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  type: NodePort
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  selector:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    app: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  ports:
</span></span></span><span style="display:flex;"><span><span style="color:#d14">  - nodePort: 8888
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    port: 80
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    targetPort: 80
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 应用后暴露效果如下：</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl apply -f ~/k8s-test/nginx-deployment-svc.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># root@k8s-node-01:~# netstat -ntlp|grep 8888</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># tcp        0      0 0.0.0.0:8888            0.0.0.0:*               LISTEN      736/kube-proxy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># root@k8s-node-02:~# netstat -ntlp|grep 8888</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># tcp        0      0 0.0.0.0:8888            0.0.0.0:*               LISTEN      739/kube-proxy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 可以直接通过云ip进行访问</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># http://10.0.26.190:8888/</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># http://10.0.26.191:8888/</span>
</span></span></code></pre></div><h2 id="常见问题">常见问题</h2>
<h3 id="kubelet启动异常">kubelet启动异常</h3>
<blockquote>
<p>systemd服务单元配置修改如下，目前来看无法从EnvironmentFile读取kubeconfig配置信息</p>
<p>Environment=&ldquo;KUBELET_KUBECONFIG_ARGS=&ndash;kubeconfig=/etc/kubernetes/pki/kubelet.kubeconfig&rdquo;
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_ARGS</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># systemctl启动异常</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># systemctl start kubelet.service</span>
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 systemd<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]</span>: Started Kubernetes systemd probe.
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 kubelet<span style="color:#000;font-weight:bold">[</span>2344<span style="color:#000;font-weight:bold">]</span>: I0525 06:42:33.115999    <span style="color:#099">2344</span> server.go:440<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;Kubelet version&#34;</span> <span style="color:#008080">kubeletVersion</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;v1.21.1&#34;</span>
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 kubelet<span style="color:#000;font-weight:bold">[</span>2344<span style="color:#000;font-weight:bold">]</span>: I0525 06:42:33.116379    <span style="color:#099">2344</span> server.go:573<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;Standalone mode, no API client&#34;</span>
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 systemd<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]</span>: run-rb0e177d4fef94a8eb15734c5cc9e09cc.scope: Succeeded.
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 kubelet<span style="color:#000;font-weight:bold">[</span>2344<span style="color:#000;font-weight:bold">]</span>: I0525 06:42:33.184752    <span style="color:#099">2344</span> server.go:488<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;No api server defined - no events will be sent to API server&#34;</span>
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 kubelet<span style="color:#000;font-weight:bold">[</span>2344<span style="color:#000;font-weight:bold">]</span>: I0525 06:42:33.185061    <span style="color:#099">2344</span> server.go:660<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /&#34;</span>
</span></span><span style="display:flex;"><span>May <span style="color:#099">25</span> 06:42:33 k8s-node-01 kubelet<span style="color:#000;font-weight:bold">[</span>2344<span style="color:#000;font-weight:bold">]</span>: I0525 06:42:33.185330    <span style="color:#099">2344</span> container_manager_linux.go:278<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;Container manager verified user specified cgroup-root exists&#34;</span> <span style="color:#008080">cgroupRoot</span><span style="color:#000;font-weight:bold">=[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 直接调用命令正常</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /usr/bin/kubelet $KUBELET_ARGS</span>
</span></span><span style="display:flex;"><span>I0525 06:42:54.713844    <span style="color:#099">2589</span> server.go:440<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;Kubelet version&#34;</span> <span style="color:#008080">kubeletVersion</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;v1.21.1&#34;</span>
</span></span><span style="display:flex;"><span>I0525 06:42:54.733089    <span style="color:#099">2589</span> dynamic_cafile_content.go:167<span style="color:#000;font-weight:bold">]</span> Starting client-ca-bundle::/etc/kubernetes/pki/ca.pem
</span></span><span style="display:flex;"><span>I0525 06:42:54.799593    <span style="color:#099">2589</span> server.go:660<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /&#34;</span>
</span></span><span style="display:flex;"><span>I0525 06:42:54.800012    <span style="color:#099">2589</span> container_manager_linux.go:278<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">&#34;Container manager verified user specified cgroup-root exists&#34;</span> <span style="color:#008080">cgroupRoot</span><span style="color:#000;font-weight:bold">=[]</span>
</span></span></code></pre></div><h3 id="kube-proxy警告">kube-proxy警告</h3>
<blockquote>
<p>版本的正常警告</p>
<p>W0521 01:54:07.352575  266283 warnings.go:70] discovery.k8s.io/v1beta1 EndpointSlice is deprecated in v1.21+, unavailable in v1.25+; use discovery.k8s.io/v1 EndpointSlice</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看api接口</span>
</span></span><span style="display:flex;"><span>kubectl api-resources -o wide
</span></span></code></pre></div><h2 id="核心插件">核心插件</h2>
<h3 id="cni网络插件flannel">CNI网络插件Flannel</h3>
<p>快速安装：For Kubernetes v1.17+ <code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></p>
<p>Flannel通过etcd读取网络，并分配没有使用的子网(docker使用此子网启动)，分配成功后，所有node更新路由</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@k8s-node-01:~# route -n
</span></span><span style="display:flex;"><span>Kernel IP routing table
</span></span><span style="display:flex;"><span>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span style="display:flex;"><span>0.0.0.0         10.0.26.1        0.0.0.0         UG    <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> enp0s3
</span></span><span style="display:flex;"><span>10.0.26.0        0.0.0.0         255.255.255.0   U     <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> enp0s3
</span></span><span style="display:flex;"><span>172.26.190.0     0.0.0.0         255.255.255.0   U     <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> docker0
</span></span><span style="display:flex;"><span>172.26.191.0     10.0.26.191      255.255.255.0   UG    <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> enp0s3 <span style="color:#998;font-style:italic"># 会自动新增其它节点路由信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@k8s-node-02:/usr/local/src# route -n
</span></span><span style="display:flex;"><span>Kernel IP routing table
</span></span><span style="display:flex;"><span>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span style="display:flex;"><span>0.0.0.0         10.0.26.1        0.0.0.0         UG    <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> enp0s3
</span></span><span style="display:flex;"><span>10.0.26.0        0.0.0.0         255.255.255.0   U     <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> enp0s3
</span></span><span style="display:flex;"><span>172.26.190.0     10.0.26.190      255.255.255.0   UG    <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> enp0s3 <span style="color:#998;font-style:italic"># 会自动新增其它节点路由信息</span>
</span></span><span style="display:flex;"><span>172.26.191.0     0.0.0.0         255.255.255.0   U     <span style="color:#099">0</span>      <span style="color:#099">0</span>        <span style="color:#099">0</span> docker0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 说明</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># k8s-node-01</span>
</span></span><span style="display:flex;"><span>190上面的docker<span style="color:#000;font-weight:bold">(</span>172.26.190.0<span style="color:#000;font-weight:bold">)</span> 访问docker网络为：172.26.191.0 指定网关为10.0.26.191，数据流向191
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># k8s-node-02</span>
</span></span><span style="display:flex;"><span>来自190<span style="color:#000;font-weight:bold">(</span>docker 172.26.190.0<span style="color:#000;font-weight:bold">)</span> 进来的数据 172.26.191.0 网络数据路由到docker0，最终实现pods数据互通
</span></span></code></pre></div><h3 id="coredns服务发现">CoreDNS服务发现</h3>
<h4 id="环境准备-3">环境准备</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ubuntu做以下处理</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 关闭，否则 /etc/resolv.conf 会被修改成 nameserver 127.0.0.53</span>
</span></span><span style="display:flex;"><span>systemctl stop systemd-resolved.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vim /etc/resolv.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nameserver 114.114.114.114
</span></span></code></pre></div><h4 id="拉取镜像">拉取镜像</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认的 k8s.gcr.io 很难下载</span>
</span></span><span style="display:flex;"><span>docker pull coredns/coredns:1.7.0
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># docker tag coredns/coredns:1.7.0 k8s.gcr.io/coredns:1.7.0</span>
</span></span><span style="display:flex;"><span>docker images
</span></span></code></pre></div><h4 id="coredns配置清单">coredns配置清单</h4>
<blockquote>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.20.2/cluster/addons/dns/coredns/coredns.yaml.base" target="_blank">https://github.com/kubernetes/kubernetes/blob/v1.20.2/cluster/addons/dns/coredns/coredns.yaml.base</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 下载资源</span>
</span></span><span style="display:flex;"><span>wget -O coredns.yaml https://raw.githubusercontent.com/kubernetes/kubernetes/v1.20.2/cluster/addons/dns/coredns/coredns.yaml.base
</span></span></code></pre></div><blockquote>
<p>修改1：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>kubernetes __DNS__DOMAIN__ in-addr.arpa ip6.arpa {<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>pods insecure<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>fallthrough in-addr.arpa ip6.arpa<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>ttl 30<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>修改为：<code>kubernetes cluster.local 10.26.0.0/16</code></p>
<blockquote>
<p>修改2：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">memory</span>:<span style="color:#bbb"> </span>__DNS__MEMORY__LIMIT__<span style="color:#bbb">
</span></span></span></code></pre></div><p>修改为：<code>memory: 150Mi</code></p>
<blockquote>
<p>修改3：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">clusterIP</span>:<span style="color:#bbb"> </span>__DNS__SERVER__<span style="color:#bbb">
</span></span></span></code></pre></div><p>修改为：<code>clusterIP: 10.26.0.2</code></p>
<blockquote>
<p>修改4：</p>
</blockquote>
<pre tabindex="0"><code>k8s.gcr.io/coredns:1.7.0 改为：coredns/coredns:1.7.0
</code></pre><h4 id="应用coredns配置">应用coredns配置</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl apply -f coredns.yaml
</span></span><span style="display:flex;"><span>kubectl get pod -n kube-system -o wide
</span></span><span style="display:flex;"><span>kubectl get svc -A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl describe pod -n kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 删除</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl delete deployment coredns -n kube-system</span>
</span></span></code></pre></div><h4 id="测试">测试</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl run pod1 --image<span style="color:#000;font-weight:bold">=</span>busybox --  sh -c <span style="color:#d14">&#34;sleep 10000&#34;</span>
</span></span><span style="display:flex;"><span>kubectl get pod -o wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 测试可用性</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#0086b3">exec</span> pod1 -- ping -c <span style="color:#099">5</span> kubernetes
</span></span><span style="display:flex;"><span>kubectl <span style="color:#0086b3">exec</span> pod1 -- nslookup kube-dns.kube-system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 登录实例</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># kubectl exec -it pod1 -- sh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 或者登录docker服务器，再进入容器</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># docker exec -it 98b8521c809a /bin/sh</span>
</span></span></code></pre></div><h3 id="ingress服务暴露控制器-traefik">ingress(服务暴露)控制器-traefik</h3>
<h3 id="dashboardkubernetes-集群的通用web-ui">dashboard（Kubernetes 集群的通用Web UI）</h3>
<h2 id="参考文档">参考文档</h2>
<ul>
<li>
<p><a href="https://www.yuque.com/swcloud/k8s/bqg7i2" target="_blank">https://www.yuque.com/swcloud/k8s/bqg7i2</a></p>
</li>
<li>
<p><a href="https://jimmysong.io/kubernetes-handbook/concepts/flannel.html" target="_blank">flannel网络解析 </a></p>
</li>
<li>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way" target="_blank">https://github.com/kelseyhightower/kubernetes-the-hard-way</a></p>
</li>
</ul>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://zazayaya.github.io/">zaza</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://zazayaya.github.io/2021/06/02/k8s-install-by-binary.html">https://zazayaya.github.io/2021/06/02/k8s-install-by-binary.html</a></li>
        <li><strong>说明：</strong>转载本站文章请标明出处，部分资源来源于网络，如有侵权请及时与我联系!</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2021/05/27/k8s-qa-test.html">K8s-kubernetes异常测试</a></li>
        
        <li><a href="/2021/05/20/openldap-tutorial-by-centos.html">Openldap-教程（centos）</a></li>
        
        <li><a href="/2021/05/20/openldap-tutorial-by-ubuntu.html">Openldap-教程（ubuntu）</a></li>
        
        <li><a href="/2021/05/20/openresty-log-example.html">Openresty-日志记录接口示例</a></li>
        
        <li><a href="/2021/05/20/docker-etcd-cluster-install.html">K8s-etcd集群搭建</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/kubernetes'>kubernetes</a></li>
                
                <li><a href='/tags/k8s'>k8s</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "zazayaya/comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://zazayaya.github.io/">zaza的博客 By zaza</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdn.bootcdn.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VHQH8V8672"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-VHQH8V8672', { 'anonymize_ip': false });
}
</script>

    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zazayaya.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zazayaya.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zazayaya.github.io/2022/06/20/windows-visual-studio-install.html" title="Visual-Studio安装配置">Visual-Studio安装配置</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2022/04/01/python-storage-by-abs.html" title="Python-通过抽象基类实现存储抽象化">Python-通过抽象基类实现存储抽象化</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2022/03/15/java-shiro-started.html" title="Java-Shiro入门学习">Java-Shiro入门学习</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2022/01/18/git-Jenkins-Maven-Gitea-Nexus-for-cicd.html" title="Git-基于Jenkins&#43;Maven&#43;Gitea&#43;Nexus搭建CICD环境">Git-基于Jenkins&#43;Maven&#43;Gitea&#43;Nexus搭建CICD环境</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/12/31/java-getting-started.html" title="Java-入门学习">Java-入门学习</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/11/08/elk-insert-nginx-log.html" title="ELK-nginx数据录入">ELK-nginx数据录入</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/11/03/docker-build-ubuntu-sshd-mysql-image.html" title="K8s-构建ubuntu&#43;sshd&#43;mysql-Docker镜像">K8s-构建ubuntu&#43;sshd&#43;mysql-Docker镜像</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/10/12/elk-6.0.0-upgrade-to-7.15.0.html" title="ELK-6.0.0升级到7.15.0">ELK-6.0.0升级到7.15.0</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/10/09/python-3.8-install-on-centos6.x-doc.html" title="Python-3.8安装文档">Python-3.8安装文档</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/09/27/elk-install-by-docker.html" title="ELK-基于docker安装">ELK-基于docker安装</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zazayaya.github.io/categories/Ansible.html">Ansible (3)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Flask.html">Flask (3)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Git.html">Git (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Java.html">Java (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Kafka.html">Kafka (5)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Kubernetes.html">Kubernetes (18)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Linux.html">Linux (19)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Mysql.html">Mysql (5)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Python.html">Python (11)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/RabbitMQ.html">RabbitMQ (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Windows.html">Windows (1)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E5%89%8D%E7%AB%AF.html">前端 (8)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE.html">大数据 (4)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E6%A0%91%E8%8E%93%E6%B4%BE.html">树莓派 (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E7%BD%91%E7%BB%9C.html">网络 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://zazayaya.github.io/tags/Visual-Studio.html">Visual Studio</a>
    
    <a href="https://zazayaya.github.io/tags/ansible.html">ansible</a>
    
    <a href="https://zazayaya.github.io/tags/axios.html">axios</a>
    
    <a href="https://zazayaya.github.io/tags/buildkit.html">buildkit</a>
    
    <a href="https://zazayaya.github.io/tags/celery.html">celery</a>
    
    <a href="https://zazayaya.github.io/tags/ceph.html">ceph</a>
    
    <a href="https://zazayaya.github.io/tags/ci/cd.html">ci/cd</a>
    
    <a href="https://zazayaya.github.io/tags/containerd.html">containerd</a>
    
    <a href="https://zazayaya.github.io/tags/crontab.html">crontab</a>
    
    <a href="https://zazayaya.github.io/tags/crypto.html">crypto</a>
    
    <a href="https://zazayaya.github.io/tags/date.html">date</a>
    
    <a href="https://zazayaya.github.io/tags/disk.html">disk</a>
    
    <a href="https://zazayaya.github.io/tags/docker.html">docker</a>
    
    <a href="https://zazayaya.github.io/tags/dockerfile.html">dockerfile</a>
    
    <a href="https://zazayaya.github.io/tags/elk.html">elk</a>
    
    <a href="https://zazayaya.github.io/tags/etcd.html">etcd</a>
    
    <a href="https://zazayaya.github.io/tags/flask.html">flask</a>
    
    <a href="https://zazayaya.github.io/tags/ftp.html">ftp</a>
    
    <a href="https://zazayaya.github.io/tags/git.html">git</a>
    
    <a href="https://zazayaya.github.io/tags/iproute.html">iproute</a>
    
    <a href="https://zazayaya.github.io/tags/iptables.html">iptables</a>
    
    <a href="https://zazayaya.github.io/tags/iredmail.html">iredmail</a>
    
    <a href="https://zazayaya.github.io/tags/java.html">java</a>
    
    <a href="https://zazayaya.github.io/tags/jumpserver.html">jumpserver</a>
    
    <a href="https://zazayaya.github.io/tags/k3s.html">k3s</a>
    
    <a href="https://zazayaya.github.io/tags/k8s.html">k8s</a>
    
    <a href="https://zazayaya.github.io/tags/kafka.html">kafka</a>
    
    <a href="https://zazayaya.github.io/tags/keepalive.html">keepalive</a>
    
    <a href="https://zazayaya.github.io/tags/knocking.html">knocking</a>
    
    <a href="https://zazayaya.github.io/tags/kubeadm.html">kubeadm</a>
    
    <a href="https://zazayaya.github.io/tags/kubernetes.html">kubernetes</a>
    
    <a href="https://zazayaya.github.io/tags/logging.html">logging</a>
    
    <a href="https://zazayaya.github.io/tags/lvs.html">lvs</a>
    
    <a href="https://zazayaya.github.io/tags/mail.html">mail</a>
    
    <a href="https://zazayaya.github.io/tags/mysql.html">mysql</a>
    
    <a href="https://zazayaya.github.io/tags/nat.html">nat</a>
    
    <a href="https://zazayaya.github.io/tags/net-tools.html">net-tools</a>
    
    <a href="https://zazayaya.github.io/tags/network.html">network</a>
    
    <a href="https://zazayaya.github.io/tags/nginx.html">nginx</a>
    
    <a href="https://zazayaya.github.io/tags/openldap.html">openldap</a>
    
    <a href="https://zazayaya.github.io/tags/openresty.html">openresty</a>
    
    <a href="https://zazayaya.github.io/tags/pureftpd.html">pureftpd</a>
    
    <a href="https://zazayaya.github.io/tags/python.html">python</a>
    
    <a href="https://zazayaya.github.io/tags/rabbitmq.html">rabbitmq</a>
    
    <a href="https://zazayaya.github.io/tags/rancher.html">rancher</a>
    
    <a href="https://zazayaya.github.io/tags/raspbian.html">raspbian</a>
    
    <a href="https://zazayaya.github.io/tags/repos.html">repos</a>
    
    <a href="https://zazayaya.github.io/tags/rsync.html">rsync</a>
    
    <a href="https://zazayaya.github.io/tags/samba.html">samba</a>
    
    <a href="https://zazayaya.github.io/tags/shell.html">shell</a>
    
    <a href="https://zazayaya.github.io/tags/supervisord.html">supervisord</a>
    
    <a href="https://zazayaya.github.io/tags/tcpping.html">tcpping</a>
    
    <a href="https://zazayaya.github.io/tags/threading.html">threading</a>
    
    <a href="https://zazayaya.github.io/tags/vpn.html">vpn</a>
    
    <a href="https://zazayaya.github.io/tags/wireguard.html">wireguard</a>
    
    <a href="https://zazayaya.github.io/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83.html">代码规范</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%88%86%E5%8C%BA.html">分区</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%89%8D%E7%AB%AF.html">前端</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E5%85%B7.html">前端工具</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%8A%A0%E5%AF%86%E5%AE%9E%E7%8E%B0.html">加密实现</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%8E%8B%E6%B5%8B.html">压测</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B.html">多线程</a>
    
    <a href="https://zazayaya.github.io/tags/%E6%A0%91%E8%8E%93%E6%B4%BE.html">树莓派</a>
    
    <a href="https://zazayaya.github.io/tags/%E8%BF%9B%E5%BA%A6%E6%9D%A1.html">进度条</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://xstarcd.github.io/" title="XStar&#39;s Wiki">XStar&#39;s Wiki</a>
        </li>
        
        <li>
            <a target="_blank" href="https://coolshell.cn/" title="coolshell">酷壳</a>
        </li>
        
        <li>
            <a target="_blank" href="https://imysql.cn/" title="iMySQL | 老叶茶馆">iMySQL | 老叶茶馆</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://zazayaya.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>