<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Openldap-教程（ubuntu） | zaza的博客</title>
    <meta property="og:title" content="Openldap-教程（ubuntu） - zaza的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-05-20T13:41:41&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-05-20T13:41:41&#43;08:00'>
        
    <meta name="Keywords" content="程序员,软件开发,code,coding,shell,bash,python,go,java,axios,css,database,debug,mysql,javascript,linux,os,programmer,programming,sql,ubuntu,centos,web">
    <meta name="description" content="Openldap-教程（ubuntu）">
        
    <meta name="author" content="zaza">
    <meta property="og:url" content="https://zazayaya.github.io/2021/05/20/openldap-tutorial-by-ubuntu.html">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zazayaya.github.io/">
                        zaza的博客
                    </a>
                
                <p class="description">系统运维</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://zazayaya.github.io/">首页</a>
                    
                    <a  href="https://zazayaya.github.io/archives.html" title="归档">归档</a>
                    
                    <a  href="https://zazayaya.github.io/about.html" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
         
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#介绍">介绍</a>
      <ul>
        <li><a href="#ldap是什么">ldap是什么</a></li>
        <li><a href="#ldap名词">ldap名词</a></li>
        <li><a href="#架构">架构</a></li>
        <li><a href="#组织方式">组织方式</a></li>
        <li><a href="#schema">schema</a></li>
        <li><a href="#应用场景">应用场景</a></li>
      </ul>
    </li>
    <li><a href="#apt快速安装">apt快速安装</a></li>
    <li><a href="#编译安装">编译安装</a>
      <ul>
        <li><a href="#依赖环境">依赖环境</a></li>
        <li><a href="#编译安装openldap">编译安装openldap</a>
          <ul>
            <li><a href="#静态编译参数说明">静态编译参数说明</a></li>
            <li><a href="#动态编译参数说明">动态编译参数说明</a></li>
            <li><a href="#openldap升级注意事项">openldap升级注意事项</a></li>
            <li><a href="#编译源码包">编译源码包</a></li>
            <li><a href="#查看编译成静态的overlays和backends模块">查看编译成静态的overlays和backends模块</a></li>
          </ul>
        </li>
        <li><a href="#源码安装pqchecker">源码安装pqchecker</a></li>
        <li><a href="#ldaps--对比-ldap-over-tls">LDAPS  对比 LDAP over TLS</a></li>
        <li><a href="#openssl生成tls证书">openssl生成tls证书</a>
          <ul>
            <li><a href="#修改opensslcnf配置文件">修改openssl.cnf配置文件</a></li>
            <li><a href="#ca证书相关">ca证书相关</a></li>
            <li><a href="#生成openldap服务证书">生成openldap服务证书</a></li>
            <li><a href="#验证证书">验证证书</a></li>
          </ul>
        </li>
        <li><a href="#配置slapdconf">配置slapd.conf</a></li>
        <li><a href="#基础配置slapdldif">基础配置slapd.ldif</a></li>
        <li><a href="#生成配置数据库">生成配置数据库</a></li>
        <li><a href="#线上激活tls">线上激活tls</a></li>
        <li><a href="#管理与测试">管理与测试</a>
          <ul>
            <li><a href="#启动">启动</a></li>
            <li><a href="#调试前台启动">调试前台启动</a></li>
            <li><a href="#关闭">关闭</a></li>
          </ul>
        </li>
        <li><a href="#导入常见的schema">导入常见的schema</a></li>
        <li><a href="#常见类的字段属性">常见类的字段属性</a></li>
      </ul>
    </li>
    <li><a href="#配置条目">配置条目</a>
      <ul>
        <li><a href="#命令行管理工具">命令行管理工具</a>
          <ul>
            <li><a href="#acl授权">ACL授权</a></li>
            <li><a href="#创建组织单元用户组">创建组织单元：用户、组</a></li>
            <li><a href="#添加系统账号">添加系统账号</a></li>
            <li><a href="#创建管理组织单元及用户">创建管理组织单元及用户</a></li>
            <li><a href="#密码管理">密码管理</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#overlay模块配置">overlay模块配置</a>
      <ul>
        <li><a href="#加载modules">加载modules</a></li>
        <li><a href="#激活memberof">激活memberOf</a>
          <ul>
            <li><a href="#使用场景">使用场景</a></li>
            <li><a href="#加载memberof">加载memberof</a></li>
            <li><a href="#激活异常">激活异常</a></li>
            <li><a href="#确认模块是否加载">确认模块是否加载</a></li>
            <li><a href="#创建memberof-overlay">创建memberof overlay</a></li>
            <li><a href="#查询memberof-overlay">查询memberof overlay</a></li>
            <li><a href="#创建memberof测试数据">创建memberof测试数据</a></li>
            <li><a href="#测试memberof是否生效">测试memberof是否生效</a></li>
            <li><a href="#uniquemember的dn值设置异常测试">uniqueMember的dn值设置异常测试</a></li>
            <li><a href="#uniquemember注意事项">UniqueMember注意事项</a></li>
          </ul>
        </li>
        <li><a href="#激活ppolicy">激活ppolicy</a>
          <ul>
            <li><a href="#加载ppolicy">加载ppolicy</a></li>
            <li><a href="#创建ppolicy-overlay">创建ppolicy overlay</a></li>
            <li><a href="#创建olcppolicydefault声明的默认策略">创建olcPPolicyDefault声明的默认策略</a></li>
            <li><a href="#关于弱密码">关于弱密码</a></li>
            <li><a href="#测试功能">测试功能</a></li>
            <li><a href="#密码策略属性">密码策略属性</a></li>
          </ul>
        </li>
        <li><a href="#激活accesslog">激活accesslog</a>
          <ul>
            <li><a href="#加载accesslog">加载accesslog</a></li>
            <li><a href="#创建accesslog-dit文件">创建accesslog dit文件</a></li>
            <li><a href="#创建accesslog-overlay">创建accesslog overlay</a></li>
            <li><a href="#查看数据">查看数据</a></li>
          </ul>
        </li>
        <li><a href="#激活auditlog">激活auditlog</a>
          <ul>
            <li><a href="#加载auditlog">加载auditlog</a></li>
          </ul>
        </li>
        <li><a href="#查看是否加载成功">查看是否加载成功</a>
          <ul>
            <li><a href="#创建auditlog-overlay">创建auditlog overlay</a></li>
            <li><a href="#测试功能-1">测试功能</a></li>
          </ul>
        </li>
        <li><a href="#异常处理">异常处理</a>
          <ul>
            <li><a href="#权限异常码50处理">权限异常码50处理</a></li>
            <li><a href="#权限异常码19处理">权限异常码19处理</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#web-ui管理工具">web ui管理工具</a>
      <ul>
        <li><a href="#环境依赖">环境依赖</a></li>
        <li><a href="#schema依赖">schema依赖</a></li>
        <li><a href="#导入schema">导入schema</a></li>
        <li><a href="#配置">配置</a></li>
        <li><a href="#测试依赖的schema">测试依赖的schema</a></li>
      </ul>
    </li>
    <li><a href="#客户端管理工具">客户端管理工具</a></li>
    <li><a href="#acl设置">ACL设置</a>
      <ul>
        <li><a href="#语法">语法</a></li>
      </ul>
    </li>
    <li><a href="#migrationtools">migrationtools</a></li>
    <li><a href="#centos接入openldap">centos接入openldap</a>
      <ul>
        <li><a href="#服务定义">服务定义</a></li>
        <li><a href="#架构图">架构图</a>
          <ul>
            <li><a href="#pam_ldap架构图">pam_ldap架构图</a></li>
            <li><a href="#nslcd架构图">nslcd架构图</a></li>
            <li><a href="#ncsd架构图">ncsd架构图</a></li>
            <li><a href="#pam登录流程">pam登录流程</a></li>
          </ul>
        </li>
        <li><a href="#相关软件包">相关软件包</a></li>
        <li><a href="#安装nslcd服务">安装nslcd服务</a>
          <ul>
            <li><a href="#安装nslcd">安装nslcd</a></li>
            <li><a href="#配置ldapd认证">配置ldapd认证</a></li>
            <li><a href="#authconfig配置变更项">authconfig配置变更项</a></li>
            <li><a href="#启动nslcd">启动nslcd</a></li>
            <li><a href="#启动nscd">启动nscd</a></li>
          </ul>
        </li>
        <li><a href="#常见问题">常见问题</a>
          <ul>
            <li><a href="#invalid-user">Invalid user</a></li>
            <li><a href="#pam_ldap-ldap_search_s-insufficient-access">pam_ldap: ldap_search_s Insufficient access</a></li>
            <li><a href="#pam_ldap-error-trying-to-bind-as-user--invalid-credentials">pam_ldap: error trying to bind as user &hellip;&hellip; (Invalid credentials)</a></li>
            <li><a href="#pam_ldap-ldap_starttls_s-connect-error">pam_ldap: ldap_starttls_s: Connect error</a></li>
            <li><a href="#access-denied-for-user-xxxx-by-pam-account-configuration">Access denied for user xxxx by PAM account configuration</a></li>
            <li><a href="#完整的登录流程日志">完整的登录流程日志</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考文档">参考文档</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 10, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Openldap-教程（ubuntu）</h1>
        </header>
        <date class="post-meta meta-date">
            2021年5月20日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/Linux'>Linux</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <blockquote>
<p>源码包版本：2.6.2</p>
<p>系统：ubuntu 20.04</p>
</blockquote>
<h2 id="介绍">介绍</h2>
<h3 id="ldap是什么">ldap是什么</h3>
<ul>
<li>LDAP：Lightweight Directory Access Protocol，轻量目录访问协议</li>
<li>LDAP服务是一个为只读（查询、浏览、搜索）访问而优化的非关系型数据库，呈树状结构组织数据</li>
<li>LDAP主要用做用户信息查询（如邮箱、电话等）或对各种服务访问做后台认证以及用户数据权限管控</li>
<li>与LDAP一样提供类似的目录服务软件还有ApacheDS、Active Directory、Red Hat Directory Service</li>
<li>自己理解：每一条DN可以由多个对象(objectClass)组成，每个对象又有不同的属性组成(必须+非必须)，其实就是以objectClass为标准，方便各个系统通用</li>
</ul>
<h3 id="ldap名词">ldap名词</h3>
<ul>
<li>DC：domain component一般为公司名，例如：dc=163,dc=com</li>
<li>OU：organization unit为组织单元，最多可以有四级，每级最长32个字符，可以为中文</li>
<li>CN：common name为用户名或者服务器名，最长可以到80个字符，可以为中文</li>
<li>DN：distinguished name为一条LDAP记录项的名字，有唯一性(类似绝对路径)，例如：dc： cn=admin,ou=developer,dc=163,dc=com&quot;</li>
<li>SN：suer name（真实名称）</li>
<li>O：organization（组织-公司）</li>
<li>C：countryName（国家）</li>
<li>ldif扩展名：<a href="http://en.wikipedia.org/wiki/LDAP_Data_Interchange_Format" target="_blank">LDAP data Interchange Format (<code>LDIF</code>)，</a> 相当于mysql的sql语句</li>
<li>olc开头：可以看到很多文件名和字段名都有前缀&quot;olc&quot; (OpenLDAP Configuration)， 理解就好。</li>
</ul>
<h3 id="架构">架构</h3>
<p>
        <a data-fancybox="gallery" href="/uploads/openldap/overlay.png">
            <img class="mx-auto" alt="Overlay" src="/uploads/openldap/overlay.png" />
        </a>
    </p>
<h3 id="组织方式">组织方式</h3>
<blockquote>
<p>企业级命名组织架构</p>
</blockquote>
<p>
        <a data-fancybox="gallery" href="/uploads/openldap/dit.png">
            <img class="mx-auto" alt="dit" src="/uploads/openldap/dit.png" />
        </a>
    </p>
<h3 id="schema">schema</h3>
<p>schema定义一个条目所包含的对象类（objectClass）以及每一个对象类所包含的属性值（attribute value）</p>
<h3 id="应用场景">应用场景</h3>
<ul>
<li>
<p>机器认证</p>
</li>
<li>
<p>用户认证</p>
</li>
<li>
<p>用户/系统组</p>
</li>
<li>
<p>地址簿</p>
</li>
<li>
<p>组织代表</p>
</li>
<li>
<p>资产追踪</p>
</li>
<li>
<p>电话信息商店</p>
</li>
<li>
<p>用户资源管理</p>
</li>
<li>
<p>电子邮件地址查询</p>
</li>
<li>
<p>应用程序配置存储</p>
</li>
<li>
<p>PBX配置存储</p>
</li>
<li>
<p>等等&hellip;..</p>
</li>
</ul>
<p>OpenLDAP属于开源集中账号管理软件。由于支持众多系统平台（Windows、Linux、Centos、Debian、Ubuntu、SUSE、Gentoo、openSUSE、Fedora、FreeBSD等），它被众多互联网企业、证券、银行、物流实现系统等用于账号的集中分配管理。</p>
<h2 id="apt快速安装">apt快速安装</h2>
<blockquote>
<p>推荐场景：简单的账号认证</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 安装</span>
</span></span><span style="display:flex;"><span>apt-get update <span style="color:#000;font-weight:bold">&amp;&amp;</span> apt install -y slapd ldap-utils
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 安装后自启动</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># systemctl status slapd.service </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 调整配置</span>
</span></span><span style="display:flex;"><span>dpkg-reconfigure slapd
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Omit OpenLDAP server configuration?    NO</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># DNS domain name: zaza.com</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Organization name: ldap01</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Administrator password: 123456</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Confirm password: 123456</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Do you want the database to be removed when slapd is purged? YES</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Move old database? YES</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看配置</span>
</span></span><span style="display:flex;"><span>ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>config dn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看 zaza.com 的 目录信息树（DIT）信息</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -b <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看用户信息</span>
</span></span><span style="display:flex;"><span>ldapwhoami -x  <span style="color:#998;font-style:italic"># 默认是匿名用户</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看admin用户信息</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldapwhoami -x -D cn=admin,dc=zaza,dc=com -W # 交互模式</span>
</span></span><span style="display:flex;"><span>ldapwhoami -x -D <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>admin,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com -w <span style="color:#099">123456</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 1、创建用户组织</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=admin,dc=zaza,dc=com&#34;</span> -w <span style="color:#099">123456</span> <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ou: People
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 2、创建组组织</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=admin,dc=zaza,dc=com&#34;</span> -w <span style="color:#099">123456</span> <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: ou=Groups,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ou: Groups
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 3、添加系统组：develop</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=admin,dc=zaza,dc=com&#34;</span> -w <span style="color:#099">123456</span> <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=develop,ou=Groups,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: posixGroup
</span></span></span><span style="display:flex;"><span><span style="color:#d14">gidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 4、添加系统账号：zaza</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=admin,dc=zaza,dc=com&#34;</span> -w <span style="color:#099">123456</span> <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: uid=zaza,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: account
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: posixAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: shadowAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uid: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">gidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">homeDirectory: /home/zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">loginShell: /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#d14">gecos: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># pam_ldap用的是MD5验证，密码为：secret
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 首次登陆后，改密为：{crypt}xxxx任然可以登录
</span></span></span><span style="display:flex;"><span><span style="color:#d14">userPassword: {MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># shadowLastChange等于0代表下次登录必须修改
</span></span></span><span style="display:flex;"><span><span style="color:#d14">shadowLastChange: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">shadowMax: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">shadowWarning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 5、添加系统账号：yaya</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=admin,dc=zaza,dc=com&#34;</span> -w <span style="color:#099">123456</span> <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># uniqueMember 必须使用 cn=yaya,ou=People,dc=zaza,dc=com 而不是 uid=yaya,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=yaya,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: account
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: posixAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: shadowAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uid: yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uidNumber: 1002
</span></span></span><span style="display:flex;"><span><span style="color:#d14">gidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">homeDirectory: /home/yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">loginShell: /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#d14">gecos: yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># pam_ldap用的是MD5验证，密码为：secret
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 首次登陆后，改密为：{crypt}xxxx任然可以登录
</span></span></span><span style="display:flex;"><span><span style="color:#d14">userPassword: {MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># shadowLastChange等于0代表下次登录必须修改
</span></span></span><span style="display:flex;"><span><span style="color:#d14">shadowLastChange: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">shadowMax: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">shadowWarning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 测试，密码为：secret</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldapwhoami -x -D uid=zaza,ou=People,dc=zaza,dc=com -W # 交互模式</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldapwhoami -x -D cn=yaya,ou=People,dc=zaza,dc=com -W # 交互模式</span>
</span></span><span style="display:flex;"><span>ldapwhoami -x -D <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>zaza,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com -w secret
</span></span><span style="display:flex;"><span>ldapwhoami -x -D <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>yaya,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com -w secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">##############################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 通过ldapadmin客户端管理</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># https://sourceforge.net/projects/ldapadmin/</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Simple authentication</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Host: 主机ip即可</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Username: cn=admin,dc=zaza,dc=com</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># PAssword: 123456</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Test connection测试通过后，点击 Fetch DNS，并选择：dc=zaza,dc=com</span>
</span></span></code></pre></div><h2 id="编译安装">编译安装</h2>
<blockquote>
<p>优势：可以安装最新的版本、快速bug修复</p>
<p>缺点：新人比较难以上手</p>
</blockquote>
<h3 id="依赖环境">依赖环境</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># enable-sql依赖：unixodbc-dev</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># with-tls依赖：libssl-dev</span>
</span></span><span style="display:flex;"><span>apt-get update <span style="color:#000;font-weight:bold">&amp;&amp;</span> apt-get -y <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  install build-essential libltdl-dev <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  unixodbc-dev libssl-dev libgnutls30
</span></span></code></pre></div><h3 id="编译安装openldap">编译安装openldap</h3>
<h4 id="静态编译参数说明">静态编译参数说明</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 静态编译说明：https://www.openldap.org/doc/admin24/overlays.html</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Backend 后端相关，默认保存在mdb数据库</span>
</span></span><span style="display:flex;"><span>--enable-sql：支持mysql、PostgreSQL等，根据自身需求确定是否开启<span style="color:#000;font-weight:bold">(</span>当前编译备用<span style="color:#000;font-weight:bold">)</span>，依赖包：unixODBC-devel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Overlay 相关</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议静态编译所有overlays，就不需要做加载步骤了，而slapd大小只增加了0.2M</span>
</span></span><span style="display:flex;"><span>--enable-modules：支持动态加载模块，这个建议开启，用于可能加载其它的overlays
</span></span><span style="display:flex;"><span>--enable-overlays：将所有可用overlay编译成静态文件至启动文件<span style="color:#000;font-weight:bold">(</span>slapd<span style="color:#000;font-weight:bold">)</span>内，源码目录：servers/slapd/overlays/，包含下面的enable
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-memberof：将memberof编译成静态文件至启动文件(slapd)内，也就是说不需要动态加载了，使用的时候定义overlay就行了</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-dynacl：动态加载ACL</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-accesslog：登录日志模块</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-auditlog：密码审计模块(修改密码的时候，日志会被记录下来)</span>
</span></span></code></pre></div><h4 id="动态编译参数说明">动态编译参数说明</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意：没有特殊需求建议编译成静态模块</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-overlays=mod</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># mod表示用动态模块(module)的方式编译模块</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-modules 这个必须开启，否则配置dn: cn=module,cn=config会报错</span>
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#000;font-weight:bold">=</span>/usr/local/openldap --enable-modules --enable-overlays<span style="color:#000;font-weight:bold">=</span>mod --enable-sql --with-tls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 编译成功后，下面的目录有相关的la文件</span>
</span></span><span style="display:flex;"><span>ll /usr/local/openldap/libexec/openldap/*.la
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看编译成静态的overlays和backends模块</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -VVV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 没有static overlays的数据了</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># (env) [root@zaza-test openldap-2.6.2]# /usr/local/openldap/libexec/slapd -VVV</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># @(#) $OpenLDAP: slapd 2.6.2 (Oct 15 2020 15:36:55) $</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     root@zaza-test:/usr/local/src/openldap-2.6.2/servers/slapd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Included static backends:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     config</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     ldif</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     bdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     hdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     mdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     relay</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     sql</span>
</span></span></code></pre></div><h4 id="openldap升级注意事项">openldap升级注意事项</h4>
<blockquote>
<p>pqchecker依赖openldap的动态库，所以openldap升级的同时需要重新编译pqchecker</p>
</blockquote>
<h4 id="编译源码包">编译源码包</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 下载</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/src
</span></span><span style="display:flex;"><span>wget https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-2.6.2.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 解压编译安装</span>
</span></span><span style="display:flex;"><span>tar xzf openldap-2.6.2.tgz <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#0086b3">cd</span> openldap-2.6.2
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#000;font-weight:bold">=</span>/usr/local/openldap --enable-modules --enable-overlays --enable-sql --with-tls
</span></span><span style="display:flex;"><span>make depend <span style="color:#000;font-weight:bold">&amp;&amp;</span> make <span style="color:#000;font-weight:bold">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 环境设置</span>
</span></span><span style="display:flex;"><span>grep -q openldap /etc/profile <span style="color:#000;font-weight:bold">||</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#39;export PATH=$PATH:/usr/local/openldap/bin:/usr/local/openldap/sbin&#39;</span> &gt;&gt; /etc/profile
</span></span><span style="display:flex;"><span><span style="color:#0086b3">source</span> /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 这里安装类似mysql的安装</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 初始状态下，LDAP是一个空目录，即没有任何数据。可通过程序代码向目录数据库中添加数据，也可使用OpenLDAP客户端工具ldapadd命令来完成添加数据的操作，该命令可将一个LDIF文件中的条目添加到目录。因此，需要首先创建一个LDIF文件，然后再进行添加操作。</span>
</span></span></code></pre></div><h4 id="查看编译成静态的overlays和backends模块">查看编译成静态的overlays和backends模块</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -VVV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 示例：</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># (env) [root@zaza-test openldap-2.6.2]# /usr/local/openldap/libexec/slapd -VVV</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># @(#) $OpenLDAP: slapd 2.6.2 (Oct 15 2020 15:36:55) $</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     root@zaza-test:/usr/local/src/openldap-2.6.2/servers/slapd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Included static overlays:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     accesslog</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     auditlog</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     collect</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     constraint</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     dds</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     deref</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     dyngroup</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     dynlist</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     memberof</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     ppolicy</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     pcache</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     refint</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     retcode</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     rwm</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     seqmod</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     sssvlv</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     syncprov</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     translucent</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     unique</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     valsort</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Included static backends:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     config</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     ldif</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     monitor</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     bdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     hdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     mdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     relay</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#     sql</span>
</span></span></code></pre></div><h3 id="源码安装pqchecker">源码安装pqchecker</h3>
<blockquote>
<p>如果启用ppolicy的密码复杂度的话，需要此三方模块</p>
<p>注意：pqchecker依赖openldap的动态库，所以openldap升级的同时需要重新编译pqchecker</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 依赖</span>
</span></span><span style="display:flex;"><span>apt-get -y install openjdk-8-jdk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 下载</span>
</span></span><span style="display:flex;"><span>wget -O pqchecker-2.0.0.tar.gz https://codeload.github.com/mahiso/pqchecker/tar.gz/v2.0.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 编译安装</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># PARAMDIR定义了策略文件目录路径，文件名为：pqparams.dat</span>
</span></span><span style="display:flex;"><span>tar xzf pqchecker-2.0.0.tar.gz <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#0086b3">cd</span> pqchecker-2.0.0
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#000;font-weight:bold">=</span>/usr/local/pqchecker <span style="color:#008080">LDAPSRC</span><span style="color:#000;font-weight:bold">=</span>/usr/local/src/openldap-2.6.2 <span style="color:#008080">JAVAHOME</span><span style="color:#000;font-weight:bold">=</span>/usr/lib/jvm/java-1.8.0-openjdk-amd64 <span style="color:#008080">PARAMDIR</span><span style="color:#000;font-weight:bold">=</span>/usr/local/openldap/etc/openldap
</span></span><span style="display:flex;"><span>make <span style="color:#000;font-weight:bold">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认的密码策略是，至少一个大写字母(UU)，一个小写字母(LL)，一个数字(DD)，一个特殊字符(SS)。</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 0|01010101</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 0|UULLDDSS</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># |号后面的为密码规则，每两位表示一个规则(0-99)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 自动生成的策略文件</span>
</span></span><span style="display:flex;"><span>cat /usr/local/openldap/etc/openldap/pqparams.dat
</span></span></code></pre></div><h3 id="ldaps--对比-ldap-over-tls">LDAPS  对比 LDAP over TLS</h3>
<ul>
<li>LDAPS：可以理解为https，加密所有数据</li>
<li>TLS：它默认走389端口，通讯的数据会加密</li>
</ul>
<h3 id="openssl生成tls证书">openssl生成tls证书</h3>
<blockquote>
<p>客户机生成请求，csr -&gt; CA签发 -&gt; crt -&gt; 拷回客户机已签名的证书</p>
<p>这里默认是v1版本，用CN验证，可以考虑使用v3版本，用SAN验证，可以使用<strong>泛域名+多ip</strong>证书认证</p>
</blockquote>
<h4 id="修改opensslcnf配置文件">修改openssl.cnf配置文件</h4>
<blockquote>
<p>执行openssl命令时参数获取默认值的配置文件，生成多个证书的时候就不用一直填写基础信息了</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 参考目录：/etc/pki/CA/</span>
</span></span><span style="display:flex;"><span>mkdir /usr/local/openldap/etc/openldap/CA
</span></span><span style="display:flex;"><span>cp /etc/ssl/openssl.cnf /usr/local/openldap/etc/openldap/CA/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 编辑配置文件</span>
</span></span><span style="display:flex;"><span>vim /usr/local/openldap/etc/openldap/CA/openssl.cnf
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">###########################################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ca默认值</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> CA_default <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008080">dir</span>     <span style="color:#000;font-weight:bold">=</span> /usr/local/openldap/etc/openldap/CA      <span style="color:#998;font-style:italic"># 定义了默认ca文件存放的路径</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">default_days</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3650</span>     <span style="color:#998;font-style:italic"># 证书有效期</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 表示证书请求request，用于生成CSR文件</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> req <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">distinguished_name</span>  <span style="color:#000;font-weight:bold">=</span> req_distinguished_name       <span style="color:#998;font-style:italic"># (DN)是一个扩展属性段落，用于指定证书请求时可被识别的字段名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span> req_distinguished_name <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># CN ==&gt; Sichuan ==&gt; Chengdu ==&gt; SYS ==&gt; IT ==&gt; zaza ==&gt; 260458726.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008080">countryName_default</span>         <span style="color:#000;font-weight:bold">=</span> CN			<span style="color:#998;font-style:italic"># 默认国家</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">stateOrProvinceName_default</span> <span style="color:#000;font-weight:bold">=</span> Sichuan       <span style="color:#998;font-style:italic"># 默认省份</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">localityName_default</span>        <span style="color:#000;font-weight:bold">=</span> Chengdu		<span style="color:#998;font-style:italic"># 默认城市</span>
</span></span><span style="display:flex;"><span>0.organizationName_default  <span style="color:#000;font-weight:bold">=</span> Internet Zaza Ltd <span style="color:#998;font-style:italic"># 默认公司</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">organizationalUnitName_default</span> <span style="color:#000;font-weight:bold">=</span> IT         <span style="color:#998;font-style:italic"># 默认部门</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Chrome 58以后不再使用CN校验地址（就是就是浏览器地址栏URL中的那个地址host）了，而是使用SAN，但是IE 11还是使用CN</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ca文件的话，就是一个根证书颁发机构的名称即可</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">commonName_default</span>          <span style="color:#000;font-weight:bold">=</span> Zaza Root CA  <span style="color:#998;font-style:italic"># CN名称，这里是颁发者，如果是签名的就是颁发给的人</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">emailAddress_default</span>        <span style="color:#000;font-weight:bold">=</span> 260458726@qq.com
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">###########################################################################################</span>
</span></span></code></pre></div><h4 id="ca证书相关">ca证书相关</h4>
<h5 id="生成ca秘钥capem">生成ca秘钥(ca.pem)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/openldap/etc/openldap/CA
</span></span><span style="display:flex;"><span>openssl genrsa -out ca.pem <span style="color:#099">4096</span>
</span></span></code></pre></div><h5 id="生成ca证书签名请求文件cacsr">生成ca证书签名请求文件(ca.csr)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Certificate Signing Request（CSR）</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 配置文件中已经有默认值了，shell交互时一路回车就行</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 其实执行req的时候，如果没有ca秘钥，会自动生成的</span>
</span></span><span style="display:flex;"><span>openssl req <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -new <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -sha256 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -out ca.csr <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -key ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -config openssl.cnf
</span></span></code></pre></div><h5 id="生成ca根证书cacrt">生成ca根证书(ca.crt)</h5>
<blockquote>
<p>这个证书就是每个客户端需要安装的根证书
存放路径：/usr/local/openldap/etc/openldap/CA/ca.crt</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl x509 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    -req <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    -days <span style="color:#099">3650</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    -in ca.csr <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    -signkey ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    -out ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看内容</span>
</span></span><span style="display:flex;"><span>openssl req -in ca.csr -text
</span></span></code></pre></div><h4 id="生成openldap服务证书">生成openldap服务证书</h4>
<h5 id="生成openldap服务秘钥openldappem">生成openldap服务秘钥(openldap.pem)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl genrsa -out openldap.pem <span style="color:#099">2048</span>
</span></span></code></pre></div><h5 id="生成openldap服务证书签名请求文件openldapcsr">生成openldap服务证书签名请求文件((openldap.csr)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl req <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -new <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -sha256 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -out openldap.csr <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -key openldap.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -config openssl.cnf
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 替换：“Zaza Root CA” 为 应服务器ip</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Common Name 注意：必须为openldap服务的域名或者对应服务器ip，否则客户端会认证失败</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Common Name 注意：必须为openldap服务的域名或者对应服务器ip，否则客户端会认证失败</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Common Name 注意：必须为openldap服务的域名或者对应服务器ip，否则客户端会认证失败</span>
</span></span></code></pre></div><h5 id="用ca证书签发终端服务证书openldapcrt">用CA证书签发终端服务证书(openldap.crt)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl x509 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -req <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -days <span style="color:#099">3650</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -CA ca.crt <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -CAkey ca.pem <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -CAcreateserial <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -in openldap.csr <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  -out openldap.crt
</span></span></code></pre></div><h4 id="验证证书">验证证书</h4>
<h5 id="通过ca证书公钥验证openldap服务端证书的合法性">通过ca证书公钥验证openldap服务端证书的合法性</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl verify -CAfile /usr/local/openldap/etc/openldap/CA/ca.crt /usr/local/openldap/etc/openldap/CA/openldap.crt
</span></span></code></pre></div><h5 id="验证openldap服务是否通过ca验证">验证openldap服务是否通过CA验证</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 需要解析域名：openldap.zaza.com，或者在hosts里面临时解析测试</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># openssl s_client -connect openldap.zaza.com:389 -showcerts -state -CAfile /usr/local/openldap/etc/openldap/CA/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 最后日志为ok代表通过</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    Verify return code: 0 (ok)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 服务器上验证</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># openssl s_client -connect openldap.zaza.com:389 -showcerts -state -CAfile /usr/local/openldap/etc/openldap/CA/ca.crt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 客户端上验证</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># openssl s_client -connect openldap.zaza.com:636 -showcerts -state -CAfile /etc/openldap/cacerts/ca.crt</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 报错，因为是系统时间不对导致的，更新时间即可：ntpdate 0.centos.pool.ntp.org</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#    Verify return code: 9 (certificate is not yet valid)</span>
</span></span></code></pre></div><h3 id="配置slapdconf"><del>配置slapd.conf</del></h3>
<p><strong>此配置文件是老版本的配置文件，新版本已经弃用</strong></p>
<blockquote>
<p>注：可以通过使用slapd将<em>slapd.conf</em>转换为<em>slapd-config</em></p>
</blockquote>
<h3 id="基础配置slapdldif">基础配置slapd.ldif</h3>
<p>vim /usr/local/openldap/etc/openldap/slapd.ldif</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># olcPidFile后面配置tls</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 配置后，同时支持tls和ssl</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 客户机生成请求，csr -&gt; CA签发 -&gt; crt -&gt; 拷回客户机已签名的证书</span>
</span></span><span style="display:flex;"><span>olcTLSCACertificateFile: /usr/local/openldap/etc/openldap/CA/ca.crt
</span></span><span style="display:flex;"><span>olcTLSCertificateFile: /usr/local/openldap/etc/openldap/CA/openldap.crt
</span></span><span style="display:flex;"><span>olcTLSCertificateKeyFile: /usr/local/openldap/etc/openldap/CA/openldap.pem
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># olcTLSVerifyClient: never # 默认选项就是never</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Load dynamic backend modules:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 这里只能配置后端模块，当前版本默认的是mdb后端</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 使用LMDB为backends后端存储模块</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 类似初始化数据库，数据库是空库(顶层根目录是：zaza.com)，通常称为BaseDN</span>
</span></span><span style="display:flex;"><span>olcSuffix: <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 最高权限，管理员账号(用户名Manager可以自定义，例如admin、root)</span>
</span></span><span style="display:flex;"><span>olcRootDN: <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>Manager,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 管理员密码</span>
</span></span><span style="display:flex;"><span>olcRootPW: secret
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议使用加密密码：slappasswd -s secret</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># MD5加密方式：slappasswd -h {MD5} -s zaza</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># olcRootPW: {SSHA}ea+EFdqmej+ORnCTwsEjD6clEa2HlMVv</span>
</span></span></code></pre></div><h3 id="生成配置数据库">生成配置数据库</h3>
<blockquote>
<p>其实就是基于slapd.ldif初始化运行环境，类似mysql的mysql_install_db</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 这个是配置数据库目录</span>
</span></span><span style="display:flex;"><span>mkdir -pv /usr/local/openldap/etc/slapd.d
</span></span><span style="display:flex;"><span>install -m <span style="color:#099">777</span> -d /usr/local/openldap/var/openldap-data
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生成配置数据库，这里必须：100.00% eta 才表示配置文件没有问题，</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/sbin/slapadd -n <span style="color:#099">0</span> -F /usr/local/openldap/etc/slapd.d -l /usr/local/openldap/etc/openldap/slapd.ldif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 临时增加config密码管理权限</span>
</span></span><span style="display:flex;"><span>grep olcRootPW /usr/local/openldap/etc/slapd.d/cn<span style="color:#d14">\=</span>config/olcDatabase<span style="color:#d14">\=\{</span>0<span style="color:#d14">\}</span>config.ldif <span style="color:#000;font-weight:bold">||</span> sed -i <span style="color:#d14">&#39;/olcRootDN: cn=config/a\olcRootPW: secret&#39;</span> /usr/local/openldap/etc/slapd.d/cn<span style="color:#d14">\=</span>config/olcDatabase<span style="color:#d14">\=\{</span>0<span style="color:#d14">\}</span>config.ldif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 使用tls即可，基于389端口，只有数据加密</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -F /usr/local/openldap/etc/slapd.d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 启动后，官方推荐命令修改(主要是有一个CRC32校验)，ldapmodify标准修改密码</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议不要修改olcRootDN: cn=config为olcRootDN: cn=Manager,dc=zaza,dc=com，因为各库功能不同，用单独账号管理</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 密码生成：slappasswd -s secret</span>
</span></span><span style="display:flex;"><span>ldapmodify -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcDatabase={0}config,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">replace: olcRootPW
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcRootPW: {SSHA}6F/6Ozu7g0IucuVGFBla/hQDdqgv/vY1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 这里才是存放后端数据的真实位置</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># olcDbDirectory: /usr/local/openldap/var/openldap-data</span>
</span></span></code></pre></div><h3 id="线上激活tls">线上激活tls</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 1、参考：openssl生成tls证书</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 2、配置</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 接口添加配置
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcTLSCACertificateFile
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcTLSCACertificateFile: /usr/local/openldap/etc/openldap/CA/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#d14">-
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcTLSCertificateFile
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcTLSCertificateFile: /usr/local/openldap/etc/openldap/CA/ldapserver.crt
</span></span></span><span style="display:flex;"><span><span style="color:#d14">-
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcTLSCertificateKeyFile
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcTLSCertificateKeyFile: /usr/local/openldap/etc/openldap/CA/ldapkey.pem
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 3、重启服务</span>
</span></span></code></pre></div><h3 id="管理与测试">管理与测试</h3>
<h4 id="启动">启动</h4>
<blockquote>
<p>相关协议</p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>URL</strong></th>
<th><strong>Protocol</strong></th>
<th><strong>Transport</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ldap:///</td>
<td>LDAP</td>
<td>TCP port 389</td>
</tr>
<tr>
<td>ldaps:///</td>
<td>LDAP over SSL</td>
<td>TCP port 636</td>
</tr>
<tr>
<td>ldapi:///</td>
<td>LDAP</td>
<td>IPC (Unix-domain socket)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># tls:基于389端口，只有数据加密</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ssl:636端口</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -F /usr/local/openldap/etc/slapd.d -h <span style="color:#d14">&#34;ldap:/// ldapi:/// ldaps:///&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 测试</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -b <span style="color:#d14">&#39;&#39;</span> -s base <span style="color:#d14">&#39;(objectclass=*)&#39;</span> namingContexts
</span></span></code></pre></div><h4 id="调试前台启动">调试前台启动</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 前台运行打印所有debug日志</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -d -1 -F /usr/local/openldap/etc/slapd.d
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 关键日志打印，如授权进程日志</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -d <span style="color:#099">128</span> -F /usr/local/openldap/etc/slapd.d
</span></span></code></pre></div><h4 id="关闭">关闭</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>killall slapd
</span></span></code></pre></div><h3 id="导入常见的schema">导入常见的schema</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 使用cn=config账号导入，密码设置参考：### 生成运行时配置</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/openldap/etc/openldap/schema
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># inetorgperson和memberOf依赖：cosine</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret -f cosine.ldif
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret -f inetorgperson.ldif
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nis包含posixAccount、shadowAccount、posixGroup</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret -f nis.ldif
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 密码策略</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret -f ppolicy.ldif
</span></span></code></pre></div><h3 id="常见类的字段属性">常见类的字段属性</h3>
<ul>
<li>PosixAccount：https://ldapwiki.com/wiki/PosixAccount</li>
<li>PosixGroup：https://ldapwiki.com/wiki/PosixGroup</li>
<li>shadowAccount：https://ldapwiki.com/wiki/shadowAccount</li>
</ul>
<h2 id="配置条目">配置条目</h2>
<h3 id="命令行管理工具">命令行管理工具</h3>
<h4 id="acl授权">ACL授权</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># mdb授权</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 权限设置，否则会报权限异常：Result: Insufficient access (50)</span>
</span></span><span style="display:flex;"><span>ldapmodify -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcAccess
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcAccess: to *
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self write
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by anonymous auth
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self read
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="创建组织单元用户组">创建组织单元：用户、组</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 首先必须添加：dn: dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 如果创建过则不需要创建了
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: dcObject
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: organization
</span></span></span><span style="display:flex;"><span><span style="color:#d14">o: zaza的测试ldap
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dc: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 创建用户组织
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ou: People
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 创建组组织
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: ou=group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ou: group
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="添加系统账号">添加系统账号</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # 添加组
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    dn: cn=zaza,ou=Group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: posixGroup
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    cn: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    gidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # 添加系统账号：zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    dn: uid=zaza,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: account
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: posixAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: shadowAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    cn: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    uid: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    uidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    gidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    homeDirectory: /home/zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    loginShell: /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    gecos: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # pam_ldap用的是MD5验证，密码为：secret
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # 首次登陆后，改密为：{crypt}xxxx任然可以登录
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    userPassword: {MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # shadowLastChange等于0代表下次登录必须修改
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    shadowLastChange: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    shadowMax: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    shadowWarning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # 添加系统账号：yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # uniqueMember 必须使用 cn=yaya,ou=People,dc=zaza,dc=com 而不是 uid=yaya,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    dn: cn=yaya,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: account
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: posixAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    objectClass: shadowAccount
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    cn: yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    uid: yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    uidNumber: 1002
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    gidNumber: 1001
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    homeDirectory: /home/yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    loginShell: /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    gecos: yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # pam_ldap用的是MD5验证，密码为：secret
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # 首次登陆后，改密为：{crypt}xxxx任然可以登录
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    userPassword: {MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    # shadowLastChange等于0代表下次登录必须修改
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    shadowLastChange: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    shadowMax: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    shadowWarning: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    EOF</span>
</span></span></code></pre></div><h4 id="创建管理组织单元及用户">创建管理组织单元及用户</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#### 也可以从文件里面读取配置</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldapadd -x -H ldap:/// -D &#34;cn=Manager,dc=zaza,dc=com&#34; -w secret -f managers.ldif</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 创建管理员单元(部门)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn:ou=managers, dc=zaza, dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ou:managers
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass:organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># managers单元下创建用户a
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn:cn=zaza,ou=managers,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># cn 常用名称
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn:zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># sn 真实名称
</span></span></span><span style="display:flex;"><span><span style="color:#d14">sn:zhangsa
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass:person
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># managers单元下创建用户b
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn:cn=yaya,ou=managers,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn:yaya
</span></span></span><span style="display:flex;"><span><span style="color:#d14">sn:lisi
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass:person
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="密码管理">密码管理</h4>
<h5 id="查询用户">查询用户</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapsearch -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(cn=zaza)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>ldapsearch -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(cn=yaya)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span></code></pre></div><h5 id="使用管理账号为用户添加密码">使用管理账号为用户添加密码</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 需要指定具体的dn值</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认自动生成随机密码，秘密会打印出来</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldappasswd -x -H ldap:/// -D &#34;cn=Manager,dc=zaza,dc=com&#34; -w secret &#34;cn=yaya,ou=People,dc=zaza,dc=com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 也可以-s指定密码</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldappasswd -x -H ldap:/// -D &#34;cn=Manager,dc=zaza,dc=com&#34; -w secret &#34;cn=yaya,ou=People,dc=zaza,dc=com&#34; -s 123456</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -s secret
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;cn=yaya,ou=People,dc=zaza,dc=com&#34;</span> -s secret
</span></span></code></pre></div><h5 id="用户权限测试">用户权限测试</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 测试，普通用户可以索引所有的数据？</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(uid=zaza)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=yaya,ou=People,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(uid=yaya)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span></code></pre></div><h5 id="用户修改密码">用户修改密码</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认ACL不能修改自己的密码</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改自己的密码</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -w secret -s secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 管理员可以修改所有</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -s secret
</span></span></code></pre></div><h2 id="overlay模块配置">overlay模块配置</h2>
<p>overlay可以理解成类似github的钩子功能</p>
<h3 id="加载modules"><del>加载modules</del></h3>
<p>modules用于加载其它没有静态编译的模块(Backend和Overlay模块)</p>
<p>当前模块所有已经做了静态编译，不需要加载这个模块</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 前置条件：激活动态加载模块(加载一次即可)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># --enable-modules这个参数实现，编译必须添加，否则报错</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=module,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcModuleList
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 这里指定动态模块路径，多个路径用冒号分割：olcModulePath: /usr/local/lib:/usr/local/lib/slapd
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 其实也可以不定义olcModulepath，因为编译的时候已经默认指定到下面的路径了
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcModulepath: /usr/local/openldap/libexec/openldap
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: module
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 加载模块
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># olcModuleLoad: memberof.la
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 也可以忽略后缀的简写方式
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># olcModuleLoad: memberof
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 也可以直接指定完整的路径
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># olcModuleLoad: /usr/local/lib/smbk5pwd.la
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h3 id="激活memberof">激活memberOf</h3>
<h4 id="使用场景">使用场景</h4>
<p>组用户有个字段叫member，可以查询当前组有哪些用户</p>
<p>但是用户没有组的属性字段，也就是用户登录的时候无法获取到自己属于哪些组</p>
<p>所以需要由系统(memberOf功能)来维护二者的映射关系。即</p>
<ul>
<li>group添加member的时候会自动给对应的entry添加memberof字段</li>
<li>当删除entry的时候，也会从group里删除member字段</li>
</ul>
<h4 id="加载memberof"><del>加载memberof</del></h4>
<p>已经静态编译则不需要加载此模块</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认已经静态编译至slapd</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=module{0},cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcModuleLoad
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcModuleLoad: memberof.la
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="激活异常"><del>激活异常</del></h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 激活的模块不存在的话，会抛出以下的异常</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span>root@zaza-test etc<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ldapadd -x -H ldap:/// -D &#34;cn=Manager,dc=zaza,dc=com&#34; -w secret &lt;&lt; EOF</span>
</span></span><span style="display:flex;"><span>&gt; dn: <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>module<span style="color:#000;font-weight:bold">{</span>0<span style="color:#000;font-weight:bold">}</span>,cn<span style="color:#000;font-weight:bold">=</span>config
</span></span><span style="display:flex;"><span>&gt; changetype: modify
</span></span><span style="display:flex;"><span>&gt; add: olcModuleLoad
</span></span><span style="display:flex;"><span>&gt; olcModulepath: /usr/local/openldap/libexec/openldap
</span></span><span style="display:flex;"><span>&gt; olcModuleLoad: aaaaaaa.la
</span></span><span style="display:flex;"><span>&gt; EOF
</span></span><span style="display:flex;"><span>modifying entry <span style="color:#d14">&#34;cn=module{0},cn=config&#34;</span>
</span></span><span style="display:flex;"><span>ldap_modify: Other <span style="color:#000;font-weight:bold">(</span>e.g., implementation specific<span style="color:#000;font-weight:bold">)</span> error <span style="color:#000;font-weight:bold">(</span>80<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	additional info: &lt;olcModuleLoad&gt; handler exited with <span style="color:#099">1</span>
</span></span></code></pre></div><h4 id="确认模块是否加载"><del>确认模块是否加载</del></h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># cat /usr/local/openldap/etc/slapd.d/cn\=config/cn\=module\{0\}.ldif</span>
</span></span><span style="display:flex;"><span>slapcat -n <span style="color:#099">0</span> -F /usr/local/openldap/etc/slapd.d | grep olcModuleLoad
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 包含以下内容标示加载成功</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># olcModuleLoad: {0}memberof.la</span>
</span></span></code></pre></div><h4 id="创建memberof-overlay">创建memberof overlay</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建olcOverlay类型的条目</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意：多次执行会创建多条</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcMemberOf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcOverlayConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: top
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcOverlay: memberof
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcMemberOfDangling: ignore
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcMemberOfRefInt: TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># groupOfNames 类对应的属性名为 member
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># groupOfUniqueNames 类对应的属性名为 uniqueMember
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># groupOfNames 和 groupOfUniqueNames 均可以使用，主要看程序的支持程度？
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 对应的类名
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcMemberOfGroupOC: groupOfUniqueNames
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 对应的属性名称
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcMemberOfMemberAD: uniqueMember
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcMemberOfMemberOfAD: memberOf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="查询memberof-overlay">查询memberof overlay</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 命令行查询</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&#34;(olcOverlay=memberof)&#34;</span> -b <span style="color:#d14">&#34;cn=config&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 或者查看文件(可能会重复录入)</span>
</span></span><span style="display:flex;"><span>ll /usr/local/openldap/etc/slapd.d/cn<span style="color:#d14">\=</span>config/olcDatabase<span style="color:#d14">\=\{</span>1<span style="color:#d14">\}</span>mdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">623</span> Oct <span style="color:#099">13</span> 11:39 <span style="color:#008080">olcOverlay</span><span style="color:#000;font-weight:bold">={</span>0<span style="color:#000;font-weight:bold">}</span>memberof.ldif
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">520</span> Oct <span style="color:#099">13</span> 11:41 <span style="color:#008080">olcOverlay</span><span style="color:#000;font-weight:bold">={</span>1<span style="color:#000;font-weight:bold">}</span>refint.ldif
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">623</span> Oct <span style="color:#099">13</span> 13:40 <span style="color:#008080">olcOverlay</span><span style="color:#000;font-weight:bold">={</span>2<span style="color:#000;font-weight:bold">}</span>memberof.ldif <span style="color:#998;font-style:italic"># 异常数据</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">623</span> Oct <span style="color:#099">13</span> 13:42 <span style="color:#008080">olcOverlay</span><span style="color:#000;font-weight:bold">={</span>3<span style="color:#000;font-weight:bold">}</span>memberof.ldif <span style="color:#998;font-style:italic"># 异常数据</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">623</span> Oct <span style="color:#099">13</span> 13:42 <span style="color:#008080">olcOverlay</span><span style="color:#000;font-weight:bold">={</span>4<span style="color:#000;font-weight:bold">}</span>memberof.ldif <span style="color:#998;font-style:italic"># 异常数据</span>
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root <span style="color:#099">623</span> Oct <span style="color:#099">13</span> 13:42 <span style="color:#008080">olcOverlay</span><span style="color:#000;font-weight:bold">={</span>5<span style="color:#000;font-weight:bold">}</span>memberof.ldif <span style="color:#998;font-style:italic"># 异常数据</span>
</span></span></code></pre></div><h4 id="创建memberof测试数据">创建memberof测试数据</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># dn: dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># objectclass: domain
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># dc: zaza
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># dn: ou=group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># objectclass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># ou: group
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># dn: ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># objectclass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># ou: People
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 测试账号：test1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: uid=test1,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass: account
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uid: test1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 测试账号：test2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: uid=test2,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass: account
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uid: test2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 测试组：testgroup1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=testgroup1,ou=group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass: groupOfUniqueNames
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: testgroup1
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 组成员
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: uid=test1,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: uid=test2,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 测试组：testgroup2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=testgroup2,ou=group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass: groupOfUniqueNames
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: testgroup2
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 组成员
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: uid=test1,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: uid=test2,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="测试memberof是否生效">测试memberof是否生效</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看test1有哪些组</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(uid=test1)&#34;</span> -b <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com memberOf
</span></span></code></pre></div><h4 id="uniquemember的dn值设置异常测试">uniqueMember的dn值设置异常测试</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 添加映射组：testusergroup1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=testusergroup1,ou=group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass: groupOfUniqueNames
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: testusergroup1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">description: testusergroup1
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># uniqueMember必须使用dn定义的记录值
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: uid=zaza,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># yaya没有这条dn，所以memberOf索引
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: uid=yaya,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 添加映射组：testusergroup2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=testusergroup2,ou=group,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectclass: groupOfUniqueNames
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: testusergroup2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">description: testusergroup2
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># uniqueMember必须使用dn定义的记录值
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># zaza没有这条dn，所以memberOf索引
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: cn=zaza,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">uniqueMember: cn=yaya,ou=People,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 只会显示：memberOf: cn=testusergroup1,ou=group,dc=zaza,dc=com，因为testusergroup2的uniqueMember配置错误啦</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(cn=zaza)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com memberOf
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 只会显示：memberOf: cn=testusergroup2,ou=group,dc=zaza,dc=com，因为testusergroup2的uniqueMember配置错误啦</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(uid=yaya)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com memberOf
</span></span></code></pre></div><h4 id="uniquemember注意事项">UniqueMember注意事项</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>uniqueMember必须使用dn定义的记录值，否则无法索引
</span></span><span style="display:flex;"><span>定义如下：
</span></span><span style="display:flex;"><span>The UniqueMember AttributeTypes is defined as:
</span></span><span style="display:flex;"><span>OID of 2.5.4.50
</span></span><span style="display:flex;"><span>NAME: UniqueMember
</span></span><span style="display:flex;"><span>DESC:
</span></span><span style="display:flex;"><span>EQUALITY:
</span></span><span style="display:flex;"><span>ORDERING:
</span></span><span style="display:flex;"><span>SYNTAX: 1.3.6.1.4.1.1466.115.121.1.12 <span style="color:#000;font-weight:bold">(</span>DN<span style="color:#000;font-weight:bold">)</span>    <span style="color:#998;font-style:italic"># 说明必须为DN值</span>
</span></span><span style="display:flex;"><span>USAGE: UserApplications
</span></span><span style="display:flex;"><span>Extended Flags:
</span></span><span style="display:flex;"><span>X-ORIGIN: RFC <span style="color:#099">4519</span>
</span></span><span style="display:flex;"><span>Used as MUST in:
</span></span><span style="display:flex;"><span>Used MAY in:
</span></span></code></pre></div><h3 id="激活ppolicy">激活ppolicy</h3>
<p>密码策略，外部模块pqchecker实现密码复杂度</p>
<p>本次加入的密码策略，大致上有以下内容：</p>
<ul>
<li>密码是长度至少为8位</li>
<li>密码至少包含数字，大写字母，小写字母，特殊字符</li>
<li>5次内使用过的密码不能再次使用</li>
<li>连续输入错误超过5次，密码将锁定5分钟</li>
</ul>
<h4 id="加载ppolicy"><del>加载ppolicy</del></h4>
<p>已静态编译，不需要动态加载了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=module{0},cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcModuleLoad
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcModuleLoad: ppolicy.la
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="创建ppolicy-overlay">创建ppolicy overlay</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcOverlay=ppolicy,olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcOverlayConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcPPolicyConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcOverlay: ppolicy
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 定义调用的默认策略DN(会默认应用这个策略)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcPPolicyDefault: cn=default,ou=policies,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcPPolicyHashCleartext: TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcPPolicyUseLockout: FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcPPolicyForwardUpdates: FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="创建olcppolicydefault声明的默认策略">创建olcPPolicyDefault声明的默认策略</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 创建ou
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: ou=policies,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: organizationalUnit
</span></span></span><span style="display:flex;"><span><span style="color:#d14">ou: People
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 创建策略,对应olcPPolicyDefault值
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=default,ou=policies,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: person
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: pwdPolicy
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: pwdPolicyChecker
</span></span></span><span style="display:flex;"><span><span style="color:#d14">cn: default
</span></span></span><span style="display:flex;"><span><span style="color:#d14">sn: default
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdAllowUserChange: TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdAttribute: userPassword
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdExpireWarning: 259200
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdFailureCountInterval: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdGraceAuthNLimit: 5
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdInHistory: 5
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdLockout: TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdLockoutDuration: 300
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdCheckQuality: 2
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdCheckModule: /usr/local/pqchecker/lib/pqchecker.so
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdMaxAge: 2592000
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdMaxFailure: 5
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdMinAge: 0
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdMinLength: 8
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 系统级别的没有必要强制改密码
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdMustChange: FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 注意此处不用添加 pwdSafeModify: TRUE, 可能会导致错误
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 该属性控制用户在密码修改操作期间是否必须发送当前密码。如果属性值为FALSE（缺省值），则用户不必发送其当前密码。如果属性值为TRUE，那么修改密码值时用户必须发送当前密码
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># pwdSafeModify: TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 密码重置
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdReset: TRUE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改属性</span>
</span></span><span style="display:flex;"><span>ldapmodify -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=default,ou=policies,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">replace: pwdMustChange
</span></span></span><span style="display:flex;"><span><span style="color:#d14">pwdMustChange: FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="关于弱密码">关于弱密码</h4>
<p>管理员重置的是弱密码也不影响流程，只有在改密码的时候才会校验密码复杂度</p>
<h4 id="测试功能">测试功能</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 可以直接修改，管理员不受此限制？</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -s secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 生效了</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -w secret -s secret
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 异常日志</span>
</span></span><span style="display:flex;"><span>Result: Constraint violation <span style="color:#000;font-weight:bold">(</span>19<span style="color:#000;font-weight:bold">)</span>     <span style="color:#998;font-style:italic"># 这个是pqchecker密码策略复杂度的错误日志</span>
</span></span><span style="display:flex;"><span>Additional info: Password fails quality checking policy  <span style="color:#998;font-style:italic"># 这个是ppolicy密码未到8位数的错误日志(ppolicy没有复杂度)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 也可以通过程序日志查看</span>
</span></span><span style="display:flex;"><span>tail -n <span style="color:#099">10</span> /var/log/syslog
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 异常日志</span>
</span></span><span style="display:flex;"><span>Oct <span style="color:#099">14</span> 17:16:11 zaza-test pqchecker<span style="color:#000;font-weight:bold">[</span>24928<span style="color:#000;font-weight:bold">]</span>: Checking password quality <span style="color:#000;font-weight:bold">for</span> <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>zaza,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com.
</span></span><span style="display:flex;"><span>Oct <span style="color:#099">14</span> 17:16:11 zaza-test pqchecker<span style="color:#000;font-weight:bold">[</span>24928<span style="color:#000;font-weight:bold">]</span>: Password rejected.
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 正常日志</span>
</span></span><span style="display:flex;"><span>Oct <span style="color:#099">14</span> 17:16:53 zaza-test pqchecker<span style="color:#000;font-weight:bold">[</span>24928<span style="color:#000;font-weight:bold">]</span>: Checking password quality <span style="color:#000;font-weight:bold">for</span> <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>zaza,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com.
</span></span><span style="display:flex;"><span>Oct <span style="color:#099">14</span> 17:16:53 zaza-test pqchecker<span style="color:#000;font-weight:bold">[</span>24928<span style="color:#000;font-weight:bold">]</span>: Password accepted.
</span></span></code></pre></div><h4 id="密码策略属性">密码策略属性</h4>
<p>密码策略涉及的属性如下：</p>
<ul>
<li>pwdAllowUserChange：允许用户修改其密码</li>
<li>pwdAttribute, pwdPolicy：对象的一个属性，用于标识用户密码。默认值(目前唯一支持的)是userPassword</li>
<li>pwdExpireWarning：密码过期前警告天数</li>
<li>pwdFailureCountInterval：多久时间后重置密码失败次数, 单位是秒</li>
<li>pwdGraceAuthNLimit：密码过期后不能登录的天数，0代表禁止登录。</li>
<li>pwdInHistory：开启密码历史记录，用于保证不能和之前设置的密码相同。</li>
<li>pwdLockout：定义用户错误密码输入次数超过pwdMaxFailure定义后, 是否锁定用户, TRUE锁定（默认）.</li>
<li>pwdLockoutDuration：密码连续输入错误次数后，帐号锁定时间。</li>
<li>pwdMaxAge：密码有效期，到期需要强制修改密码, 2592000是30天</li>
<li>pwdMaxFailure：密码最大失效次数，超过后帐号被锁定。</li>
<li>pwdMinAge：密码最小有效期, 默认为0, 用户随时更改密码, 如果定义了, 用户在离上次更改密码 + 定义的时间之内不能更改密码</li>
<li>pwdMinLength：用户修改密码时最短的密码长度</li>
<li>pwdMustChange：用户在帐户锁定后由管理员重置帐户后是否必须更改密码, 并且只有在pwdLockout为TRUE时才相关, 如果值为FLASE(默认值), 管理员帮用户解锁用户后, 用户不必更改密码, 如果为TRUE, 就必须更改密码。如果使用pwdReset来解锁用户, 其值将覆盖此属性</li>
<li>pwdSafeModify：该属性控制用户在密码修改操作期间是否必须发送当前密码。如果属性值为FALSE（缺省值），则用户不必发送其当前密码。如果属性值为TRUE，那么修改密码值时用户必须发送当前密码。</li>
<li>pwdLockoutDuration：帐号锁定后，不能自动解锁，此时需要管理员干涉</li>
</ul>
<h3 id="激活accesslog">激活accesslog</h3>
<p>用于记录用户操作</p>
<h4 id="加载accesslog"><del>加载accesslog</del></h4>
<p>已静态编译，不需要动态加载了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=module{0},cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcModuleLoad
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcModuleLoad: accesslog.la
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看是否加载成功</span>
</span></span><span style="display:flex;"><span>slapcat -n <span style="color:#099">0</span> -F /usr/local/openldap/etc/slapd.d | grep olcModuleLoad
</span></span></code></pre></div><h4 id="创建accesslog-dit文件">创建accesslog dit文件</h4>
<p>类似创建mysql的数据库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 目录信息树(Directory Information Tree (DIT))是指数据被表示在一种分级的树形结构中</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># accesslog实际上是保存到单独的mdb里面</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 类似创建mysql的数据库</span>
</span></span><span style="display:flex;"><span>mkdir -pv /usr/local/openldap/var/openldap-data/accesslog
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 新创建一个DIT文件：/usr/local/openldap/etc/slapd.d/cn=config/olcDatabase={2}mdb.ldif</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建了一个独立的mdb路径，类似创建mysql实例</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcDatabase={2}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: add
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcDatabaseConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcMdbConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcDatabase: {2}mdb
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcDbDirectory: /usr/local/openldap/var/openldap-data/accesslog
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcSuffix: cn=accesslog
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 管理员账号可以查询此数据
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcRootDN: cn=Manager,dc=zaza,dc=com
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcDbIndex: default eq
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 需要记录的数据
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcDbIndex: entryCSN,objectClass,reqEnd,reqResult,reqStart
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看结果</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># (env) [root@zaza-test ~]# tree /usr/local/openldap/var/openldap-data/</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /usr/local/openldap/var/openldap-data/</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ├── accesslog      # 独立的accesslog(类似mysql的实例)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># │   ├── data.mdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># │   └── lock.mdb</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ├── data.mdb       # 账户数据数据(类似mysql的实例)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ├── DB_CONFIG.example</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># └── lock.mdb</span>
</span></span></code></pre></div><h4 id="创建accesslog-overlay">创建accesslog overlay</h4>
<pre tabindex="0"><code>ldapadd -x -H ldap:/// -D &#34;cn=config&#34; -w secret &lt;&lt; EOF
dn: olcOverlay=accesslog,olcDatabase={1}mdb,cn=config
changetype: add
objectClass: olcOverlayConfig
objectClass: olcAccessLogConfig
olcOverlay: accesslog
olcAccessLogDB: cn=accesslog
olcAccessLogOps: all
olcAccessLogSuccess: TRUE
olcAccessLogPurge: 30+00:00 01+00:00
EOF
</code></pre><h4 id="查看数据">查看数据</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 先来一条测试数据</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;(uid=yaya)&#34;</span> -b <span style="color:#008080">ou</span><span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看日志</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret -b <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>accesslog
</span></span></code></pre></div><h3 id="激活auditlog">激活auditlog</h3>
<p>审计功能，如修改密码</p>
<p>以标准的LDIF格式记录数据库的所有变更，类似mysql的binlog数据</p>
<p>承载压力大的服务器，建议添加定时任务(或者logrotate)进行切割、归档、压缩</p>
<h4 id="加载auditlog"><del>加载auditlog</del></h4>
<p>已经静态编译则不需要加载此模块</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: cn=module{0},cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: modify
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcModuleLoad
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcModuleLoad: auditlog.la
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h3 id="查看是否加载成功">查看是否加载成功</h3>
<p>slapcat -n 0 -F /usr/local/openldap/etc/slapd.d | grep olcModuleLoad</p>
<h4 id="创建auditlog-overlay">创建auditlog overlay</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建日志目录</span>
</span></span><span style="display:flex;"><span>mkdir -pv /usr/local/openldap/var/log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 创建overlay</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcOverlay=auditlog,olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">changetype: add
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcOverlayConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">objectClass: olcAuditLogConfig
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcOverlay: auditlog
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcAuditlogFile: /usr/local/openldap/var/log/auditlog.ldif
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># mdb授权</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 权限设置，否则会报权限异常：Result: Insufficient access (50)</span>
</span></span><span style="display:flex;"><span>ldapmodify -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcAccess
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcAccess: to *
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self write
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by anonymous auth
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self read
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="测试功能-1">测试功能</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 先来一条测试数据</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -s secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 用户自己没有权限修改密码了？</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -w secret -s secret
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 没有权限的异常日志</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Result: Insufficient access (50)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看日志</span>
</span></span><span style="display:flex;"><span>cat /usr/local/openldap/var/log/auditlog.ldif
</span></span></code></pre></div><h3 id="异常处理">异常处理</h3>
<h4 id="权限异常码50处理">权限异常码50处理</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 用户自己没有权限修改密码了？</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -w secret -s secret
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 没有权限的异常日志</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Result: Insufficient access (50)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议调试模式运行</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /usr/local/openldap/libexec/slapd -d -1 -F /usr/local/openldap/etc/slapd.d</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 获取的异常日志如下(获取50关键字)</span>
</span></span><span style="display:flex;"><span>5f86c582 mdb_modify_internal: 0x00000008: <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>zaza,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span><span style="color:#008080">5f86c582</span> <span style="color:#000;font-weight:bold">=</span>&gt; access_allowed: backend default write access denied to <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> <span style="color:#998;font-style:italic"># 这个问题导致的，发现没有写权限导致的</span>
</span></span><span style="display:flex;"><span>5f86c626 mdb_modify_internal: 0x00000008: <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>zaza,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span><span style="color:#008080">5f86c626</span> <span style="color:#000;font-weight:bold">=</span>&gt; access_allowed: backend default write access denied to <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span>
</span></span><span style="display:flex;"><span>5f86c626 mdb_modify: modify failed <span style="color:#000;font-weight:bold">(</span>50<span style="color:#000;font-weight:bold">)</span>              <span style="color:#998;font-style:italic"># 没有权限操作</span>
</span></span><span style="display:flex;"><span>5f86c626 send_ldap_result: <span style="color:#008080">conn</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1008</span> <span style="color:#008080">op</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#008080">p</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>5f86c626 send_ldap_result: <span style="color:#008080">err</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">50</span> <span style="color:#008080">matched</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span> <span style="color:#008080">text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>5f86c626 slap_graduate_commit_csn: removing 0x7fdf9c104a60 20201014093430.033623Z#000000#000#000000
</span></span><span style="display:flex;"><span>5f86c626 send_ldap_extended: <span style="color:#008080">err</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">50</span> <span style="color:#008080">oid</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">len</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>5f86c626 send_ldap_response: <span style="color:#008080">msgid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span> <span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">120</span> <span style="color:#008080">err</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">50</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 解决方法：mdb授权自己可写即可</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认权限</span>
</span></span><span style="display:flex;"><span>Backend ACL: access to *
</span></span><span style="display:flex;"><span>	by * none
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 权限设置，否则会报权限异常：Result: Insufficient access (50)</span>
</span></span><span style="display:flex;"><span>ldapmodify -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcAccess
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcAccess: to *
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self write
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by anonymous auth
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self read
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span></code></pre></div><h4 id="权限异常码19处理">权限异常码19处理</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 秘密合规的状态下，返回异常码19</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -w secret -s secret@#D
</span></span><span style="display:flex;"><span>Result: Constraint violation <span style="color:#000;font-weight:bold">(</span>19<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 调试查看</span>
</span></span><span style="display:flex;"><span>/usr/local/openldap/libexec/slapd -d -1 -F /usr/local/openldap/etc/slapd.d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 异常日志如下</span>
</span></span><span style="display:flex;"><span>5f87ff7c check_password_quality: module error: <span style="color:#000;font-weight:bold">(</span>/usr/local/pqchecker/lib/pqchecker.so<span style="color:#000;font-weight:bold">)</span> Unable to verify the quality of the password. Problem in parameters..<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>5f87ff7c send_ldap_result: <span style="color:#008080">conn</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1000</span> <span style="color:#008080">op</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#008080">p</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">3</span>
</span></span><span style="display:flex;"><span>5f87ff7c send_ldap_result: <span style="color:#008080">err</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">19</span> <span style="color:#008080">matched</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span> <span style="color:#008080">text</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;Unable to verify the quality of the password. Problem in parameters.&#34;</span>
</span></span><span style="display:flex;"><span>5f87ff7c send_ldap_extended: <span style="color:#008080">err</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">19</span> <span style="color:#008080">oid</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">len</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>
</span></span><span style="display:flex;"><span>5f87ff7c send_ldap_response: <span style="color:#008080">msgid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span> <span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">120</span> <span style="color:#008080">err</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">19</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 想起了是因为openldap版本升级了，而编译pqchecker又依赖openldap的动态库，所以需要重新编译pqchecker</span>
</span></span></code></pre></div><h2 id="web-ui管理工具">web ui管理工具</h2>
<p>ldap-account-management</p>
<h3 id="环境依赖">环境依赖</h3>
<ul>
<li>nginx</li>
<li>php &gt;= 7.0.0</li>
</ul>
<h3 id="schema依赖">schema依赖</h3>
<p>用户
个人信息   在你的LDAP服务器中对象类inetOrgPerson不被支持。
Unix      在你的LDAP服务器中对象类posixAccount不被支持。
Shadow    在你的LDAP服务器中对象类shadowAccount不被支持。</p>
<p>组
Unix      在你的LDAP服务器中对象类posixGroup不被支持。</p>
<h3 id="导入schema">导入schema</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> /usr/local/openldap/etc/openldap/schema
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># inetorgperson依赖cosine</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret -f cosine.ldif
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret -f inetorgperson.ldif
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nis包含posixAccount、shadowAccount、posixGroup</span>
</span></span><span style="display:flex;"><span>ldapadd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret -f nis.ldif
</span></span></code></pre></div><h3 id="配置">配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http://localhost/ldap-account-manager/templates/config/conflogin.php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>服务器地址：ldap://10.0.26.26
</span></span><span style="display:flex;"><span>树状结构后缀：dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>合法用户列表：cn<span style="color:#000;font-weight:bold">=</span>Manager,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span></code></pre></div><h3 id="测试依赖的schema">测试依赖的schema</h3>
<p>http://localhost/ldap-account-manager/templates/tests/schemaTest.php</p>
<h2 id="客户端管理工具">客户端管理工具</h2>
<p><a href="http://www.ldapadmin.org/download/ldapadmin.html" target="_blank">http://www.ldapadmin.org/download/ldapadmin.html</a></p>
<h2 id="acl设置">ACL设置</h2>
<h3 id="语法">语法</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>olcAccess: to <span style="color:#000;font-weight:bold">[</span>resources<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	by <span style="color:#000;font-weight:bold">[</span>who<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0086b3">type</span> of access granted<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">[</span>control<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	by <span style="color:#000;font-weight:bold">[</span>who<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0086b3">type</span> of access granted<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">[</span>control<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic"># More &#39;by&#39; clauses, if necessary....</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># mdb授权</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 默认权限</span>
</span></span><span style="display:flex;"><span>Backend ACL: access to *
</span></span><span style="display:flex;"><span>	by * none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改权限</span>
</span></span><span style="display:flex;"><span>ldapmodify -x -H ldap:/// -D <span style="color:#d14">&#34;cn=config&#34;</span> -w secret <span style="color:#d14">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#d14">dn: olcDatabase={1}mdb,cn=config
</span></span></span><span style="display:flex;"><span><span style="color:#d14">add: olcAccess
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 权限设置，否则auditlog模块会报权限异常：Result: Insufficient access (50)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">olcAccess: to *
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self write
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by anonymous auth
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    by self read
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 示例</span>
</span></span><span style="display:flex;"><span>https://my.oschina.net/u/142602/blog/134746
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>olcAccess: to *
</span></span><span style="display:flex;"><span>    by self write
</span></span><span style="display:flex;"><span>    by anonymous auth
</span></span><span style="display:flex;"><span>    by self <span style="color:#0086b3">read</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>access to <span style="color:#008080">attrs</span><span style="color:#000;font-weight:bold">=</span>userPassword
</span></span><span style="display:flex;"><span>by self write
</span></span><span style="display:flex;"><span>by anonymous auth
</span></span><span style="display:flex;"><span>by dn.base<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;cn=Manager,dc=mycompany,dc=com&#34;</span> write
</span></span><span style="display:flex;"><span>by * none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>access to *
</span></span><span style="display:flex;"><span>by self write
</span></span><span style="display:flex;"><span>by dn.base<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;cn=Manager,dc=mycompany,dc=com&#34;</span> write
</span></span><span style="display:flex;"><span>by * <span style="color:#0086b3">read</span>
</span></span></code></pre></div><h2 id="migrationtools">migrationtools</h2>
<p><em>migrationtools</em> 开源工具通过查找/etc/passwd、/etc/shadow、/etc/groups 生成LDIF 文件,并通过ldapadd 命令更新数据库数据,完成用户添加</p>
<h2 id="centos接入openldap">centos接入openldap</h2>
<h3 id="服务定义">服务定义</h3>
<ul>
<li>nslcd：Daemon for NSS and PAM lookups using LDAP，增强了nss_ldap功能，预设RFC2307标准</li>
<li>nscd：name service cache daemon 用于缓存信息：passwd, group, hosts databases through standard libc interfaces (getpwnam, getpwuid, getgrnam, getgrgid, gethostbyname, and others)</li>
<li>sssd: System Security Services Daemon 红帽独立的认证套件，本文档不用此服务进行认证</li>
</ul>
<h3 id="架构图">架构图</h3>
<h4 id="pam_ldap架构图">pam_ldap架构图</h4>
<p>实现客户端和服务端交互</p>
<p>
        <a data-fancybox="gallery" href="https://www.idmworks.com/wp-content/uploads/2020/05/PAM_Overview.png">
            <img class="mx-auto" alt="" src="https://www.idmworks.com/wp-content/uploads/2020/05/PAM_Overview.png" />
        </a>
    </p>
<h4 id="nslcd架构图">nslcd架构图</h4>
<p>主要是增强了nss_ldap功能</p>
<p>
        <a data-fancybox="gallery" href="https://arthurdejong.org/nss-pam-ldapd/nss-pam-ldapd-overview.png">
            <img class="mx-auto" alt="" src="https://arthurdejong.org/nss-pam-ldapd/nss-pam-ldapd-overview.png" />
        </a>
    </p>
<h4 id="ncsd架构图">ncsd架构图</h4>
<p>缓存的数据</p>
<p>
        <a data-fancybox="gallery" href="https://keymon.files.wordpress.com/2010/08/libnss_default_schema.jpg">
            <img class="mx-auto" alt="" src="https://keymon.files.wordpress.com/2010/08/libnss_default_schema.jpg" />
        </a>
    </p>
<h4 id="pam登录流程">pam登录流程</h4>
<ol>
<li>ssh登录(/etc/ssh/sshd_config有pam的配置UsePAM yes)，此时nslcd(/etc/nscd.conf)会向openldap请求相关用户数据</li>
<li>本地和openldap返回没有命中相关账号(Invalid user xxxx)的话则退出</li>
<li>账号存在的话，pam首先进入pam_unix流程，认证失败，进入pam_ldap流程</li>
<li>pam_ldap(/etc/pam_ldap.conf)向openldap请求用户密码数据</li>
<li>密码匹配成功后登陆完成，失败则退出登录</li>
</ol>
<h3 id="相关软件包">相关软件包</h3>
<ul>
<li>/etc/nsswitch.conf  ==&gt;  rpm -ql glibc-2.12-1.212.el6_10.3.x86_64|egrep nsswitch.conf</li>
<li>/etc/sysconfig/authconfig ==&gt;  rpm -ql authconfig-6.1.12-23.el6.x86_64|egrep &ldquo;sysconfig/authconfig&rdquo;</li>
<li>/etc/pam.d/system-auth ==&gt; rpm -ql pam-1.1.1-22.el6.x86_64|grep system</li>
<li>/etc/pam_ldap.conf  ==&gt;  rpm -ql pam_ldap-185-11.el6.x86_64|grep pam_ldap.conf</li>
<li>/etc/nslcd.conf ==&gt; rpm -ql nss-pam-ldapd-0.7.5-32.el6_10.1.x86_64|grep nslcd.conf</li>
<li>/etc/openldap/ldap.conf ==&gt; rpm -ql openldap.x86_64|grep ldap.conf 所以导致openldap-clients无法使用此配置文件？ openldap服务</li>
</ul>
<h3 id="安装nslcd服务">安装nslcd服务</h3>
<p>原理说明：</p>
<p>The file <code>nslcd.conf</code> contains the configuration information for running <strong>nslcd</strong> (see nslcd(8)). The file contains options, one on each line, defining the way NSS lookups and PAM actions are mapped to LDAP lookups.</p>
<ul>
<li>pam_ldap原理：https://arthurdejong.org/nss-pam-ldapd/pam_ldap.8</li>
</ul>
<h4 id="安装nslcd">安装nslcd</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nslcd进程由以下包提供</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># centos：nss-pam-ldapd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ubuntu:  nslcd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nss-pam-ldapd依赖包：nscd、pam_ldap</span>
</span></span><span style="display:flex;"><span>yum -y install nss-pam-ldapd
</span></span></code></pre></div><h4 id="配置ldapd认证">配置ldapd认证</h4>
<p><strong>强烈建议使用authconfig配置openldap认证，直接修改配置文件容易出错！！！因为每个系统都不一样，配置也有一定的区别</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 强烈建议使用authconfig配置openldap认证，直接修改配置文件容易出错！！！，每个系统都不一样，配置也有一定的区别</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 配置前一定要备份</span>
</span></span><span style="display:flex;"><span>authconfig --savebackup<span style="color:#000;font-weight:bold">=</span>/opt/openldap_<span style="color:#000;font-weight:bold">$(</span>date +%s<span style="color:#000;font-weight:bold">)</span>.bak
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 配置后会自动启动nslcd</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 建议使用：sha512加密模式，目前linux密码用的加密方式，比较安全</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># authconfig --enableldap --enableldapauth --ldapserver=ldap://10.0.26.26 --disableldaptls --enablemkhomedir --ldapbasedn=&#34;dc=zaza,dc=com&#34; --update</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># TLS可以简单理解为ldaps的升级：它默认走389端口(所以ldapserver仍然是ldap://)，但是传输数据的会加密</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldap的地址必须为openssl对应的Common Name值</span>
</span></span><span style="display:flex;"><span>authconfig --enableldap --enableldapauth --ldapserver<span style="color:#000;font-weight:bold">=</span>ldap://10.0.26.26 --enableldaptls --enablemkhomedir --ldapbasedn<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;dc=zaza,dc=com&#34;</span> --update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 配置异常后恢复命令</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># authconfig --restorebackup=/opt/openldap_xxxxxxx.bak</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 测试</span>
</span></span><span style="display:flex;"><span>authconfig --test | grep ldap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 重启sshd</span>
</span></span><span style="display:flex;"><span>/etc/init.d/sshd restart
</span></span></code></pre></div><h4 id="authconfig配置变更项">authconfig配置变更项</h4>
<p><strong>自动生成的不要手动修改，除了增加openldap的账号密码！！！</strong></p>
<p>下面配置的是管理员账号，正常情况下授权一个只读账号到指定的ou(和属性)即可</p>
<h5 id="etcsysconfigauthconfig">/etc/sysconfig/authconfig</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /etc/sysconfig/authconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">USEMKHOMEDIR</span><span style="color:#000;font-weight:bold">=</span>yes
</span></span><span style="display:flex;"><span><span style="color:#008080">USELDAPAUTH</span><span style="color:#000;font-weight:bold">=</span>yes
</span></span><span style="display:flex;"><span><span style="color:#008080">USELDAP</span><span style="color:#000;font-weight:bold">=</span>yes
</span></span></code></pre></div><h5 id="etcnslcdconf">/etc/nslcd.conf</h5>
<p><strong>需要手动修改部分配置</strong></p>
<p>vim /etc/nslcd.conf</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意：如果有密码认证的话需要单独新增账号配置(binddn和bindpw)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 开启tls的话，证书配置文件需要调整</span>
</span></span><span style="display:flex;"><span>uri ldap://10.0.26.26
</span></span><span style="display:flex;"><span>base <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>ssl start_tls
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#tls_cacertdir /etc/openldap/cacerts</span>
</span></span><span style="display:flex;"><span>tls_cacertfile /etc/openldap/cacerts/ca.crt
</span></span><span style="display:flex;"><span>binddn <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>Manager,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>bindpw secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 映射说明</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># https://arthurdejong.org/nss-pam-ldapd/nslcd.conf.5</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># map MAP ATTRIBUTE NEWATTRIBUTE</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 映射 映射的组件 映射的远程属性(RFC 2307)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#map    passwd homeDirectory    unixHomeDirectory</span>
</span></span></code></pre></div><h5 id="etcnsswitchconf">/etc/nsswitch.conf</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>passwd:     files ldap
</span></span><span style="display:flex;"><span>shadow:     files ldap
</span></span><span style="display:flex;"><span>group:      files ldap
</span></span><span style="display:flex;"><span>netgroup:   files ldap
</span></span><span style="display:flex;"><span>automount:  files ldap
</span></span></code></pre></div><h5 id="etcopenldapldapconf">/etc/openldap/ldap.conf</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>TLS_CACERTDIR /etc/openldap/cacerts
</span></span><span style="display:flex;"><span>URI ldap://10.0.26.26
</span></span><span style="display:flex;"><span>BASE <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意如果有密码认证的话需要单独新增账号配置</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># binddn cn=Manager,dc=zaza,dc=com</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># bindpw secret</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 还没有找到此配置文件的用处，因为没有安装openldap-clients软件包</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># TLS_REQCERT never</span>
</span></span><span style="display:flex;"><span>URI  ldap://10.0.26.26
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># URI 可以配置多个openldap服务器</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># URI  ldap://192.168.1.2 ldap://192.168.1.3</span>
</span></span><span style="display:flex;"><span>BASE <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 报错则使用调试模式测试</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ldap_sasl_bind(SIMPLE): Can&#39;t contact LDAP server (-1)</span>
</span></span><span style="display:flex;"><span>ldapsearch -x -LLL -d1
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 发现配置文件没有生效：ldap_connect_to_host: TCP localhost:389</span>
</span></span></code></pre></div><h5 id="etcpam_ldapconf">/etc/pam_ldap.conf</h5>
<p><strong>需要手动修改部分配置</strong></p>
<p>vim /etc/pam_ldap.conf</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># pam_ldap.so会读取此配置文件</span>
</span></span><span style="display:flex;"><span>base <span style="color:#008080">dc</span><span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>uri ldap://10.0.26.26
</span></span><span style="display:flex;"><span>ssl start_tls
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#tls_cacertdir /etc/openldap/cacerts</span>
</span></span><span style="display:flex;"><span>tls_cacertfile /etc/openldap/cacerts/ca.crt
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># md5加密模式</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 首次登陆后，改密为：{crypt}xxxx任然可以登录</span>
</span></span><span style="display:flex;"><span>pam_password md5
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意如果有密码认证的话需要单独新增账号配置</span>
</span></span><span style="display:flex;"><span>binddn <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>Manager,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>bindpw secret
</span></span></code></pre></div><h5 id="etcpamd">/etc/pam.d</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 强烈建议使用authconfig配置openldap认证，直接修改配置文件容易出错！！！，每个系统都不一样，配置也有一定的区别</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /etc/pam.d/system-auth-ac</span>
</span></span><span style="display:flex;"><span>auth        sufficient    pam_ldap.so use_first_pass
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># auth        required      pam_deny.so</span>
</span></span><span style="display:flex;"><span>account     required      pam_unix.so broken_shadow
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># account     sufficient    pam_localuser.so</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Saccount     sufficient    pam_succeed_if.so uid &lt; 500 quiet</span>
</span></span><span style="display:flex;"><span>account     <span style="color:#000;font-weight:bold">[</span><span style="color:#008080">default</span><span style="color:#000;font-weight:bold">=</span>bad <span style="color:#008080">success</span><span style="color:#000;font-weight:bold">=</span>ok <span style="color:#008080">user_unknown</span><span style="color:#000;font-weight:bold">=</span>ignore<span style="color:#000;font-weight:bold">]</span> pam_ldap.so
</span></span><span style="display:flex;"><span>password    sufficient    pam_ldap.so use_authtok
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># password    required      pam_deny.so</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># session     required      pam_limits.so</span>
</span></span><span style="display:flex;"><span>session     optional      pam_mkhomedir.so <span style="color:#008080">umask</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0077</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># session     required      pam_unix.so</span>
</span></span><span style="display:flex;"><span>session     optional      pam_ldap.so
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /etc/pam.d/smartcard-auth-ac 没有必要吧</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 指纹识别?  应该没有必要/etc/pam.d/fingerprint-auth-ac</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># /etc/pam.d/password-auth-ac</span>
</span></span><span style="display:flex;"><span>auth        sufficient    pam_ldap.so use_first_pass
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># auth        required      pam_deny.so</span>
</span></span><span style="display:flex;"><span>account     required      pam_unix.so broken_shadow
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># account     sufficient    pam_localuser.so</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># account     sufficient    pam_succeed_if.so uid &lt; 500 quiet</span>
</span></span><span style="display:flex;"><span>account     <span style="color:#000;font-weight:bold">[</span><span style="color:#008080">default</span><span style="color:#000;font-weight:bold">=</span>bad <span style="color:#008080">success</span><span style="color:#000;font-weight:bold">=</span>ok <span style="color:#008080">user_unknown</span><span style="color:#000;font-weight:bold">=</span>ignore<span style="color:#000;font-weight:bold">]</span> pam_ldap.so
</span></span><span style="display:flex;"><span>password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
</span></span><span style="display:flex;"><span>password    sufficient    pam_ldap.so use_authtok
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># password    required      pam_deny.so</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># session     required      pam_limits.so</span>
</span></span><span style="display:flex;"><span>session     optional      pam_mkhomedir.so <span style="color:#008080">umask</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0077</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># session     required      pam_unix.so</span>
</span></span><span style="display:flex;"><span>session     optional      pam_ldap.so
</span></span></code></pre></div><h4 id="启动nslcd">启动nslcd</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># authconfig执行后正常情况下回自动启动nslcd程序</span>
</span></span><span style="display:flex;"><span>/etc/init.d/nslcd start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># debug模式</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 注意时间：ntpdate 0.centos.pool.ntp.org</span>
</span></span><span style="display:flex;"><span>nslcd -d
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 测试</span>
</span></span><span style="display:flex;"><span>getent passwd zaza  <span style="color:#998;font-style:italic"># 测试 nslcd 通信是否正常</span>
</span></span><span style="display:flex;"><span>ssh zaza@127.0.0.1  <span style="color:#998;font-style:italic"># 测试 pam_ldap是否正常</span>
</span></span></code></pre></div><h4 id="启动nscd">启动nscd</h4>
<p>确认可以正常登录后，就可以启动密码缓存功能了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 如何确认数据已经缓存了呢？</span>
</span></span><span style="display:flex;"><span>/etc/init.d/nscd start
</span></span></code></pre></div><h3 id="常见问题">常见问题</h3>
<h4 id="invalid-user">Invalid user</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tailf /var/log/secure
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 直接报远程账号不存在</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:43 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1633<span style="color:#000;font-weight:bold">]</span>: Invalid user zaza from 10.0.26.28               <span style="color:#998;font-style:italic"># 没有索引到账号，说明nslcd获取列表账号失败</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:43 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1634<span style="color:#000;font-weight:bold">]</span>: input_userauth_request: invalid user zaza
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:43 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1633<span style="color:#000;font-weight:bold">]</span>: pam_unix<span style="color:#000;font-weight:bold">(</span>sshd:auth<span style="color:#000;font-weight:bold">)</span>: check pass; user unknown
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:43 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1633<span style="color:#000;font-weight:bold">]</span>: pam_unix<span style="color:#000;font-weight:bold">(</span>sshd:auth<span style="color:#000;font-weight:bold">)</span>: authentication failure; <span style="color:#008080">logname</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span> <span style="color:#008080">euid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span> <span style="color:#008080">tty</span><span style="color:#000;font-weight:bold">=</span>ssh <span style="color:#008080">ruser</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">rhost</span><span style="color:#000;font-weight:bold">=</span>10.0.26.28 
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:43 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1633<span style="color:#000;font-weight:bold">]</span>: pam_succeed_if<span style="color:#000;font-weight:bold">(</span>sshd:auth<span style="color:#000;font-weight:bold">)</span>: error retrieving information about user zaza
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:45 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1633<span style="color:#000;font-weight:bold">]</span>: Failed password <span style="color:#000;font-weight:bold">for</span> invalid user zaza from 10.0.26.28 port <span style="color:#099">14886</span> ssh2
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:59 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1634<span style="color:#000;font-weight:bold">]</span>: Received disconnect from 10.0.26.28: 0: 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看日志</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 验证看一下有没有远程的账号，错误的时候：没有数据打印出来</span>
</span></span><span style="display:flex;"><span>getent passwd zaaz
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 查看错误日志</span>
</span></span><span style="display:flex;"><span>tailf /var/log/messages
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 04:38:43 <span style="color:#0086b3">test</span> nslcd<span style="color:#000;font-weight:bold">[</span>1498<span style="color:#000;font-weight:bold">]</span>: <span style="color:#000;font-weight:bold">[</span>b0dc51<span style="color:#000;font-weight:bold">]</span> ldap_result<span style="color:#000;font-weight:bold">()</span> failed: Insufficient access <span style="color:#998;font-style:italic"># 说明nslcd账号配置错误</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 解决：/etc/nslcd.conf添加相关账号，并重启</span>
</span></span><span style="display:flex;"><span>binddn <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>Manager,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>bindpw secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改后重启</span>
</span></span><span style="display:flex;"><span>/etc/init.d/nslcd restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 获取数据成功</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@test ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># getent passwd zaza</span>
</span></span><span style="display:flex;"><span>zaza:x:1001:1001:zaza:/home/zaza:/bin/bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 或者这样测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@test ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># id zaza</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>1001<span style="color:#000;font-weight:bold">(</span>zaza<span style="color:#000;font-weight:bold">)</span> <span style="color:#008080">gid</span><span style="color:#000;font-weight:bold">=</span>1001<span style="color:#000;font-weight:bold">(</span>zaza<span style="color:#000;font-weight:bold">)</span> <span style="color:#008080">groups</span><span style="color:#000;font-weight:bold">=</span>1001<span style="color:#000;font-weight:bold">(</span>zaza<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="pam_ldap-ldap_search_s-insufficient-access">pam_ldap: ldap_search_s Insufficient access</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tailf /var/log/secure
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:09:56 <span style="color:#0086b3">test</span> unix_chkpwd<span style="color:#000;font-weight:bold">[</span>1720<span style="color:#000;font-weight:bold">]</span>: password check failed <span style="color:#000;font-weight:bold">for</span> user <span style="color:#000;font-weight:bold">(</span>zaza<span style="color:#000;font-weight:bold">)</span>   <span style="color:#998;font-style:italic"># 这个数据正常，说明获取账号ok，unix_chkpwd true的代表命中暴力破解？</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:09:56 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1718<span style="color:#000;font-weight:bold">]</span>: pam_unix<span style="color:#000;font-weight:bold">(</span>sshd:auth<span style="color:#000;font-weight:bold">)</span>: authentication failure; <span style="color:#008080">logname</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span> <span style="color:#008080">euid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span> <span style="color:#008080">tty</span><span style="color:#000;font-weight:bold">=</span>ssh <span style="color:#008080">ruser</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">rhost</span><span style="color:#000;font-weight:bold">=</span>localhost  <span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>zaza  <span style="color:#998;font-style:italic"># 本地认证错误是正常的，因为是远程账号</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:10:06 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1718<span style="color:#000;font-weight:bold">]</span>: pam_ldap: ldap_search_s Insufficient access <span style="color:#998;font-style:italic"># 进入pam_ldap认证流程，但是报没有权限查询相关账号数据</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:10:08 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1718<span style="color:#000;font-weight:bold">]</span>: Failed password <span style="color:#000;font-weight:bold">for</span> zaza from 127.0.0.1 port <span style="color:#099">43989</span> ssh2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 解决方法：修改pam_ldap配置文件</span>
</span></span><span style="display:flex;"><span>vim /etc/pam_ldap.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>binddn <span style="color:#008080">cn</span><span style="color:#000;font-weight:bold">=</span>Manager,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>bindpw secret
</span></span></code></pre></div><h4 id="pam_ldap-error-trying-to-bind-as-user--invalid-credentials">pam_ldap: error trying to bind as user &hellip;&hellip; (Invalid credentials)</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tailf /var/log/secure
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:17:47 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1729<span style="color:#000;font-weight:bold">]</span>: pam_ldap: error trying to <span style="color:#0086b3">bind</span> as user <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> <span style="color:#000;font-weight:bold">(</span>Invalid credentials<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:17:49 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1729<span style="color:#000;font-weight:bold">]</span>: Failed password <span style="color:#000;font-weight:bold">for</span> zaza from 127.0.0.1 port <span style="color:#099">43993</span> ssh2
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:17:58 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1730<span style="color:#000;font-weight:bold">]</span>: Connection closed by 127.0.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 到这一步说明：nslcd已经可以正常查询说有的数据，pam_ldap也可以正常的查询玩家密码信息，但是密码不匹配，需要确认一下pam_ldap配置的密码类型和创建的账号加密类型是否一致</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@test ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># grep &#34;^pam_password&#34; /etc/pam_ldap.conf</span>
</span></span><span style="display:flex;"><span>pam_password md5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 添加系统账号：zaza</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 这里是crypt类型和pam_ldap.conf配置的(md5)不匹配导致的</span>
</span></span><span style="display:flex;"><span>dn: <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>zaza,ou<span style="color:#000;font-weight:bold">=</span>People,dc<span style="color:#000;font-weight:bold">=</span>zaza,dc<span style="color:#000;font-weight:bold">=</span>com
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># userPassword: {SSHA}RAEPE0fK0Mmq0KbUoRlTs/Rldd1vHI2t</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># userPassword 需要改成，密码为：secret</span>
</span></span><span style="display:flex;"><span>userPassword: <span style="color:#000;font-weight:bold">{</span>MD5<span style="color:#000;font-weight:bold">}</span><span style="color:#008080">Xr4ilOzQ4PCOq3aQ0qbuaQ</span><span style="color:#000;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改密码</span>
</span></span><span style="display:flex;"><span>ldappasswd -x -H ldap:/// -D <span style="color:#d14">&#34;cn=Manager,dc=zaza,dc=com&#34;</span> -w secret <span style="color:#d14">&#34;uid=zaza,ou=People,dc=zaza,dc=com&#34;</span> -s secret
</span></span></code></pre></div><h4 id="pam_ldap-ldap_starttls_s-connect-error">pam_ldap: ldap_starttls_s: Connect error</h4>
<p>服务端报错：TLS: can&rsquo;t accept: A TLS packet with unexpected length was received..  (证书长度错误，不是预期的长度)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># https://serverfault.com/questions/628512/pam-ldap-and-ldaps-cant-contact-ldap-server</span>
</span></span><span style="display:flex;"><span>My CA certificate is the correct one, but openldap uses Mozilla Network Security Services <span style="color:#000;font-weight:bold">(</span>MozNSS<span style="color:#000;font-weight:bold">)</span> by default <span style="color:#000;font-weight:bold">for</span> checking the authority. So I have to add my self-signed CA to this database.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 导入成MozNSS数据库格式</span>
</span></span><span style="display:flex;"><span>certutil -d /etc/openldap/certs -A -n <span style="color:#d14">&#34;ldap CA&#34;</span> -t TCu,Cu,Tuw -a -i /etc/openldap/cacerts/ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 验证</span>
</span></span><span style="display:flex;"><span>certutil -L -d /etc/openldap/certs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 修改配置文件</span>
</span></span><span style="display:flex;"><span>vim /etc/pam_ldap.conf
</span></span><span style="display:flex;"><span>tls_cacertdir /etc/openldap/certs
</span></span></code></pre></div><h4 id="access-denied-for-user-xxxx-by-pam-account-configuration">Access denied for user xxxx by PAM account configuration</h4>
<h5 id="异常状态selinuxenforcing导致的待测试">异常状态(SELINUX=enforcing导致的？待测试)</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 连接服务器后直接退出（一）</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@test ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ssh zaza@127.0.0.1</span>
</span></span><span style="display:flex;"><span>zaza@127.0.0.1<span style="color:#d14">&#39;s password: 
</span></span></span><span style="display:flex;"><span><span style="color:#d14">You are required to change your LDAP password immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Connection closed by 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 连接服务器后直接退出（二）
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[root@test ~]# ssh zaza@127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">zaza@127.0.0.1&#39;</span>s password: 
</span></span><span style="display:flex;"><span>Connection closed by 127.0.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># secure相关日志</span>
</span></span><span style="display:flex;"><span>tailf /var/log/secure
</span></span><span style="display:flex;"><span>Oct <span style="color:#099">20</span> 20:42:16 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1452<span style="color:#000;font-weight:bold">]</span>: fatal: Access denied <span style="color:#000;font-weight:bold">for</span> user zaza by PAM account configuration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 重启sshd，任然异常</span>
</span></span><span style="display:flex;"><span>/etc/init.d/sshd restart
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 重启服务器，任然异常</span>
</span></span></code></pre></div><h5 id="正常状态">正常状态</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 调试环境就可以正常登录，并提示修改密码</span>
</span></span><span style="display:flex;"><span>/usr/sbin/sshd -p <span style="color:#099">2222</span> -d
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 或者：/etc/init.d/sshd stop &amp;&amp; /usr/sbin/sshd -d</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 连接服务器</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@test ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ssh zaza@127.0.0.1 -p 2222</span>
</span></span><span style="display:flex;"><span>zaza@127.0.0.1<span style="color:#d14">&#39;s password: 
</span></span></span><span style="display:flex;"><span><span style="color:#d14">You are required to change your password immediately (root enforced)
</span></span></span><span style="display:flex;"><span><span style="color:#d14">You are required to change your LDAP password immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Last login: Tue Oct 20 23:26:49 2020 from localhost
</span></span></span><span style="display:flex;"><span><span style="color:#d14">WARNING: Your password has expired.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">You must change your password now and login again!
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Changing password for user zaza.
</span></span></span><span style="display:flex;"><span><span style="color:#d14">Enter login(LDAP) password: 
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 使用bash执行，就可以正常登录，并提示修改密码
</span></span></span><span style="display:flex;"><span><span style="color:#d14">bash /etc/init.d/sshd restart
</span></span></span><span style="display:flex;"><span><span style="color:#d14"># 连接服务器
</span></span></span><span style="display:flex;"><span><span style="color:#d14">[root@test ~]# ssh zaza@127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#d14">zaza@127.0.0.1&#39;</span>s password: 
</span></span><span style="display:flex;"><span>You are required to change your password immediately <span style="color:#000;font-weight:bold">(</span>root enforced<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>You are required to change your LDAP password immediately.
</span></span><span style="display:flex;"><span>Last login: Tue Oct <span style="color:#099">20</span> 23:35:53 <span style="color:#099">2020</span> from localhost
</span></span><span style="display:flex;"><span>WARNING: Your password has expired.
</span></span><span style="display:flex;"><span>You must change your password now and login again!
</span></span><span style="display:flex;"><span>Changing password <span style="color:#000;font-weight:bold">for</span> user zaza.
</span></span><span style="display:flex;"><span>Enter login<span style="color:#000;font-weight:bold">(</span>LDAP<span style="color:#000;font-weight:bold">)</span> password: 
</span></span></code></pre></div><h4 id="完整的登录流程日志">完整的登录流程日志</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:18 <span style="color:#0086b3">test</span> unix_chkpwd<span style="color:#000;font-weight:bold">[</span>1753<span style="color:#000;font-weight:bold">]</span>: password check failed <span style="color:#000;font-weight:bold">for</span> user <span style="color:#000;font-weight:bold">(</span>zaza<span style="color:#000;font-weight:bold">)</span> <span style="color:#998;font-style:italic"># 暴力破解校验</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:18 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1751<span style="color:#000;font-weight:bold">]</span>: pam_unix<span style="color:#000;font-weight:bold">(</span>sshd:auth<span style="color:#000;font-weight:bold">)</span>: authentication failure; <span style="color:#008080">logname</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span> <span style="color:#008080">euid</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span> <span style="color:#008080">tty</span><span style="color:#000;font-weight:bold">=</span>ssh <span style="color:#008080">ruser</span><span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">rhost</span><span style="color:#000;font-weight:bold">=</span>localhost  <span style="color:#008080">user</span><span style="color:#000;font-weight:bold">=</span>zaza <span style="color:#998;font-style:italic"># 本地验证失败</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:29 <span style="color:#0086b3">test</span> unix_chkpwd<span style="color:#000;font-weight:bold">[</span>1754<span style="color:#000;font-weight:bold">]</span>: account zaza has password changed in future <span style="color:#998;font-style:italic"># 暴力破解校验</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:29 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1751<span style="color:#000;font-weight:bold">]</span>: Accepted password <span style="color:#000;font-weight:bold">for</span> zaza from 127.0.0.1 port <span style="color:#099">43997</span> ssh2 <span style="color:#998;font-style:italic"># 远程校验成功</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:29 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1751<span style="color:#000;font-weight:bold">]</span>: pam_unix<span style="color:#000;font-weight:bold">(</span>sshd:session<span style="color:#000;font-weight:bold">)</span>: session opened <span style="color:#000;font-weight:bold">for</span> user zaza by <span style="color:#000;font-weight:bold">(</span><span style="color:#008080">uid</span><span style="color:#000;font-weight:bold">=</span>0<span style="color:#000;font-weight:bold">)</span> <span style="color:#998;font-style:italic"># session走本地流程</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:52 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1756<span style="color:#000;font-weight:bold">]</span>: Received disconnect from 127.0.0.1: 11: disconnected by user <span style="color:#998;font-style:italic"># 远程退出</span>
</span></span><span style="display:flex;"><span>Jul  <span style="color:#099">8</span> 05:36:52 <span style="color:#0086b3">test</span> sshd<span style="color:#000;font-weight:bold">[</span>1751<span style="color:#000;font-weight:bold">]</span>: pam_unix<span style="color:#000;font-weight:bold">(</span>sshd:session<span style="color:#000;font-weight:bold">)</span>: session closed <span style="color:#000;font-weight:bold">for</span> user zaza <span style="color:#998;font-style:italic"># 关闭session信息</span>
</span></span></code></pre></div><h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1490857" target="_blank">很好的文档</a></li>
<li><a href="http://www.openldap.org/doc/admin24/guide.html" target="_blank">官方文档</a></li>
<li><a href="http://www.zytrax.com/books/ldap" target="_blank">比官网更友好的ldap文档</a></li>
<li><a href="https://www.cnblogs.com/kevingrace/p/5773974.html" target="_blank">写的贼详细的ldap介绍</a></li>
<li><a href="https://www.cnblogs.com/kevingrace/p/9052669.html" target="_blank">写的贼详细的ldap安装记录</a></li>
<li><a href="https://devopsideas.com/planning-of-ldap-dit-structure-and-config-of-overlays-access-ppolicy/" target="_blank">Overlays结构及激活memberOf</a></li>
<li><a href="https://ldapwiki.com/wiki/GroupOfUniqueNames%20vs%20groupOfNames" target="_blank">GroupOfUniqueNames vs groupOfNames</a></li>
<li><a href="http://www.mamicode.com/info-detail-2330358.html" target="_blank">OpenLDAP密码策略</a></li>
<li><a href="https://www.meddeb.net/pqchecker/?Idx=3" target="_blank">pqchecker模块测试</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/1406_liulz_pamopenldap/index.html" target="_blank">使用PAM集成OpenLDAP实现Linux统一管理系统用户</a></li>
<li><a href="https://github.com/arthurdejong/nss-pam-ldapd" target="_blank">nss-pam-ldapd官方文档</a></li>
<li><a href="https://www.cnblogs.com/nidey/p/9041960.html" target="_blank">openssl非常好的文档(一)</a></li>
<li><a href="https://www.php.cn/linux-372638.html" target="_blank">openssl非常好的文档(二)</a></li>
</ul>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://zazayaya.github.io/">zaza</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://zazayaya.github.io/2021/05/20/openldap-tutorial-by-ubuntu.html">https://zazayaya.github.io/2021/05/20/openldap-tutorial-by-ubuntu.html</a></li>
        <li><strong>说明：</strong>转载本站文章请标明出处，部分资源来源于网络，如有侵权请及时与我联系!</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2021/05/20/openldap-tutorial-by-centos.html">Openldap-教程（centos）</a></li>
        
        <li><a href="/2021/05/20/openresty-log-example.html">Openresty-日志记录接口示例</a></li>
        
        <li><a href="/2021/05/20/docker-etcd-cluster-install.html">K8s教程-etcd集群搭建</a></li>
        
        <li><a href="/2021/05/12/linux-date.html">Linux-date常见使用</a></li>
        
        <li><a href="/2021/05/12/python-contextor.html">Python-上下文管理器</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/openldap'>openldap</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "zazayaya/comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://zazayaya.github.io/">zaza的博客 By zaza</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdn.bootcdn.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VHQH8V8672"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-VHQH8V8672', { 'anonymize_ip': false });
}
</script>

    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zazayaya.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zazayaya.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zazayaya.github.io/2022/06/20/windows-visual-studio-install.html" title="Visual-Studio安装配置">Visual-Studio安装配置</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2022/04/01/python-storage-by-abs.html" title="Python-通过抽象基类实现存储抽象化">Python-通过抽象基类实现存储抽象化</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2022/03/15/java-shiro-started.html" title="Java-Shiro入门学习">Java-Shiro入门学习</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2022/01/18/git-Jenkins-Maven-Gitea-Nexus-for-cicd.html" title="Git-基于Jenkins&#43;Maven&#43;Gitea&#43;Nexus搭建CICD环境">Git-基于Jenkins&#43;Maven&#43;Gitea&#43;Nexus搭建CICD环境</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/12/31/java-getting-started.html" title="Java-入门学习">Java-入门学习</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/11/08/elk-insert-nginx-log.html" title="ELK-nginx数据录入">ELK-nginx数据录入</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/11/03/docker-build-ubuntu-sshd-mysql-image.html" title="K8s教程-构建ubuntu&#43;sshd&#43;mysql-Docker镜像">K8s教程-构建ubuntu&#43;sshd&#43;mysql-Docker镜像</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/10/12/elk-6.0.0-upgrade-to-7.15.0.html" title="ELK-6.0.0升级到7.15.0">ELK-6.0.0升级到7.15.0</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/10/09/python-3.8-install-on-centos6.x-doc.html" title="Python-3.8安装文档">Python-3.8安装文档</a>
    </li>
    
    <li>
        <a href="https://zazayaya.github.io/2021/09/27/elk-install-by-docker.html" title="ELK-基于docker安装">ELK-基于docker安装</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zazayaya.github.io/categories/Ansible.html">Ansible (3)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Flask.html">Flask (3)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Git.html">Git (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Java.html">Java (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Kafka.html">Kafka (5)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Kubernetes.html">Kubernetes (18)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Linux.html">Linux (19)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Mysql.html">Mysql (5)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Python.html">Python (11)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/RabbitMQ.html">RabbitMQ (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/Windows.html">Windows (1)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E5%89%8D%E7%AB%AF.html">前端 (8)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE.html">大数据 (4)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E6%A0%91%E8%8E%93%E6%B4%BE.html">树莓派 (2)</a></li>
    
    <li><a href="https://zazayaya.github.io/categories/%E7%BD%91%E7%BB%9C.html">网络 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://zazayaya.github.io/tags/Visual-Studio.html">Visual Studio</a>
    
    <a href="https://zazayaya.github.io/tags/ansible.html">ansible</a>
    
    <a href="https://zazayaya.github.io/tags/axios.html">axios</a>
    
    <a href="https://zazayaya.github.io/tags/buildkit.html">buildkit</a>
    
    <a href="https://zazayaya.github.io/tags/celery.html">celery</a>
    
    <a href="https://zazayaya.github.io/tags/ceph.html">ceph</a>
    
    <a href="https://zazayaya.github.io/tags/ci/cd.html">ci/cd</a>
    
    <a href="https://zazayaya.github.io/tags/containerd.html">containerd</a>
    
    <a href="https://zazayaya.github.io/tags/crontab.html">crontab</a>
    
    <a href="https://zazayaya.github.io/tags/crypto.html">crypto</a>
    
    <a href="https://zazayaya.github.io/tags/date.html">date</a>
    
    <a href="https://zazayaya.github.io/tags/disk.html">disk</a>
    
    <a href="https://zazayaya.github.io/tags/docker.html">docker</a>
    
    <a href="https://zazayaya.github.io/tags/dockerfile.html">dockerfile</a>
    
    <a href="https://zazayaya.github.io/tags/elk.html">elk</a>
    
    <a href="https://zazayaya.github.io/tags/etcd.html">etcd</a>
    
    <a href="https://zazayaya.github.io/tags/flask.html">flask</a>
    
    <a href="https://zazayaya.github.io/tags/ftp.html">ftp</a>
    
    <a href="https://zazayaya.github.io/tags/git.html">git</a>
    
    <a href="https://zazayaya.github.io/tags/iproute.html">iproute</a>
    
    <a href="https://zazayaya.github.io/tags/iptables.html">iptables</a>
    
    <a href="https://zazayaya.github.io/tags/iredmail.html">iredmail</a>
    
    <a href="https://zazayaya.github.io/tags/java.html">java</a>
    
    <a href="https://zazayaya.github.io/tags/jumpserver.html">jumpserver</a>
    
    <a href="https://zazayaya.github.io/tags/k3s.html">k3s</a>
    
    <a href="https://zazayaya.github.io/tags/k8s.html">k8s</a>
    
    <a href="https://zazayaya.github.io/tags/kafka.html">kafka</a>
    
    <a href="https://zazayaya.github.io/tags/keepalive.html">keepalive</a>
    
    <a href="https://zazayaya.github.io/tags/knocking.html">knocking</a>
    
    <a href="https://zazayaya.github.io/tags/kubeadm.html">kubeadm</a>
    
    <a href="https://zazayaya.github.io/tags/kubernetes.html">kubernetes</a>
    
    <a href="https://zazayaya.github.io/tags/logging.html">logging</a>
    
    <a href="https://zazayaya.github.io/tags/lvs.html">lvs</a>
    
    <a href="https://zazayaya.github.io/tags/mail.html">mail</a>
    
    <a href="https://zazayaya.github.io/tags/mysql.html">mysql</a>
    
    <a href="https://zazayaya.github.io/tags/nat.html">nat</a>
    
    <a href="https://zazayaya.github.io/tags/net-tools.html">net-tools</a>
    
    <a href="https://zazayaya.github.io/tags/network.html">network</a>
    
    <a href="https://zazayaya.github.io/tags/nginx.html">nginx</a>
    
    <a href="https://zazayaya.github.io/tags/openldap.html">openldap</a>
    
    <a href="https://zazayaya.github.io/tags/openresty.html">openresty</a>
    
    <a href="https://zazayaya.github.io/tags/pureftpd.html">pureftpd</a>
    
    <a href="https://zazayaya.github.io/tags/python.html">python</a>
    
    <a href="https://zazayaya.github.io/tags/rabbitmq.html">rabbitmq</a>
    
    <a href="https://zazayaya.github.io/tags/rancher.html">rancher</a>
    
    <a href="https://zazayaya.github.io/tags/raspbian.html">raspbian</a>
    
    <a href="https://zazayaya.github.io/tags/repos.html">repos</a>
    
    <a href="https://zazayaya.github.io/tags/rsync.html">rsync</a>
    
    <a href="https://zazayaya.github.io/tags/samba.html">samba</a>
    
    <a href="https://zazayaya.github.io/tags/shell.html">shell</a>
    
    <a href="https://zazayaya.github.io/tags/supervisord.html">supervisord</a>
    
    <a href="https://zazayaya.github.io/tags/tcpping.html">tcpping</a>
    
    <a href="https://zazayaya.github.io/tags/threading.html">threading</a>
    
    <a href="https://zazayaya.github.io/tags/vpn.html">vpn</a>
    
    <a href="https://zazayaya.github.io/tags/wireguard.html">wireguard</a>
    
    <a href="https://zazayaya.github.io/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83.html">代码规范</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%88%86%E5%8C%BA.html">分区</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%89%8D%E7%AB%AF.html">前端</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E5%85%B7.html">前端工具</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%8A%A0%E5%AF%86%E5%AE%9E%E7%8E%B0.html">加密实现</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%8E%8B%E6%B5%8B.html">压测</a>
    
    <a href="https://zazayaya.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B.html">多线程</a>
    
    <a href="https://zazayaya.github.io/tags/%E6%A0%91%E8%8E%93%E6%B4%BE.html">树莓派</a>
    
    <a href="https://zazayaya.github.io/tags/%E8%BF%9B%E5%BA%A6%E6%9D%A1.html">进度条</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://xstarcd.github.io/" title="XStar&#39;s Wiki">XStar&#39;s Wiki</a>
        </li>
        
        <li>
            <a target="_blank" href="https://coolshell.cn/" title="coolshell">酷壳</a>
        </li>
        
        <li>
            <a target="_blank" href="https://imysql.cn/" title="iMySQL | 老叶茶馆">iMySQL | 老叶茶馆</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://zazayaya.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>